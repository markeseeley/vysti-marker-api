<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vysti Marker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/assets/marker.css">


  <!-- Supabase JS client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <header class="topbar">
        <div class="brand">
          <img src="/assets/logo.svg" alt="Vysti" />
        </div>
      
        <nav>
          <a href="#" class="">Dashboard</a>
          <a href="/index.html" class="active">Mark Assignments</a>
          <a href="#" class="">Document Review</a>
          <a href="#" class="">Settings</a>
        </nav>
      
        <div class="actions">
          <button class="iconbtn" type="button" title="Notifications" aria-label="Notifications"></button>
          <img class="avatar" src="/assets/avatar.png" alt="Profile" />
          <button class="iconbtn" id="logoutBtn" type="button" title="Log out" aria-label="Log out"></button>
        </div>
      </header>
      

  <!-- Simple auth panel -->
  

  <main class="page">
      <form id="markForm" class="marker-grid" style="display:none;">

    
    
<section class="card form-card">
    
    
    <label>
        Select assignment
        <select id="mode">
          <option value="textual_analysis">Textual analysis</option>
          <!-- Intertextual analysis removed; multiple works are supported via the fields below -->
          <option value="peel_paragraph">PEEL paragraph</option>
          <option value="reader_response">Reader response</option>
          <option value="analytic_frame">Analytic frame</option>
          <option value="argumentation">Argumentation</option>
          <option value="foundation_1">First sentence only</option>
          <option value="foundation_2">First sentence + thesis</option>
          <option value="foundation_3">Full introduction</option>
          <option value="foundation_4">Intro + topic sentence</option>
          <option value="foundation_5">Intro + body</option>
          <option value="foundation_6">Full essay</option>
        </select>
      </label>
      <p id="modeHelp"></p>
      <!-- Work 1 -->
    <fieldset>
        <legend>Work 1</legend>
        <label>
          What is the author's full name?
          <input type="text" id="author" />
        </label>
  
        <label>
          What is the title of the text?
          <input type="text" id="title" />
        </label>
  
        <div class="title-type-block">
          <div class="title-type-label">Title type</div>
        
          <div class="title-type-grid">
            <label class="type-option tt" data-tip="The title of the text must be in double quotation marks.">
              <span class="type-head">
                <input type="radio" name="title1_type" value="true" checked />
                <span class="type-name">Minor work</span>
              </span>
            </label>
          
            <label class="type-option tt" data-tip="The title of the text must be in italics.">
              <span class="type-head">
                <input type="radio" name="title1_type" value="false" />
                <span class="type-name">Major work</span>
              </span>
            </label>
          </div>
          
            
            
          </div>
        
          <!-- Keep the existing select for your JS/backend -->
          <select id="title_is_minor" class="hidden-select" aria-hidden="true" tabindex="-1">
            <option value="true" selected>Minor work — in &quot;double quotes&quot;</option>
            <option value="false">Major work — italicized</option>
          </select>
        </div>
        
      </fieldset>
  
      <!-- Work 2 (optional) -->
      <fieldset>
        <legend>Work 2</legend>
        <label>
          Author 2
          <input type="text" id="author2" />
        </label>
  
        <label>
          Title 2
          <input type="text" id="title2" />
        </label>
  
        <div class="title-type-block">
          <div class="title-type-label">Title type</div>
        
          <select id="title2_is_minor" class="hidden-select" aria-hidden="true" tabindex="-1" disabled>
            <option value="true" selected>Minor work — in "double quotes"</option>
            <option value="false">Major work — in italics</option>
          </select>
        
          <div class="title-type-grid">
            <label class="type-option tt" data-tip="The title of the text must be in double quotation marks.">
              <span class="type-head">
                <input type="radio" name="title2_type" value="true" checked />
                <span class="type-name">Minor work</span>
              </span>
            </label>

            <label class="type-option tt" data-tip="The title of the text must be in italics.">
              <span class="type-head">
                <input type="radio" name="title2_type" value="false" />
                <span class="type-name">Major work</span>
              </span>
            </label>
            
          </div>
        </div>
        
      </fieldset>
  
      <!-- Work 3 (optional) -->
      <fieldset>
        <legend>Work 3</legend>
        <label>
          Author 3
          <input type="text" id="author3" />
        </label>
  
        <label>
          Title 3
          <input type="text" id="title3" />
        </label>
  
        <div class="title-type-block">
          <div class="title-type-label">Title type</div>
        
          <select id="title3_is_minor" class="hidden-select" aria-hidden="true" tabindex="-1" disabled>
            <option value="true" selected>Minor work — in "double quotes"</option>
            <option value="false">Major work — in italics</option>
          </select>
        
          <div class="title-type-grid">
            <label class="type-option tt" data-tip="The title of the text must be in double quotation marks.">
              <span class="type-head">
                <input type="radio" name="title3_type" value="true" checked />
                <span class="type-name">Minor work</span>
              </span>
            </label>
            
        
            <label class="type-option tt" data-tip="The title of the text must be in italics.">
              <span class="type-head">
                <input type="radio" name="title3_type" value="false" />
                <span class="type-name">Major work</span>
              </span>
            </label>
            
          </div>
        </div>
        
      </fieldset>
      <button class="primary-btn" type="submit">Mark Essay</button>
  </section>
  
  
  <section class="card upload-card">
      <label>Essays (.docx)</label>
      

      <div id="dropZone" class="drop-zone" tabindex="0" role="button" aria-label="Upload .docx files">
          <img class="dz-icon" src="/assets/cloud-upload.svg" alt="" aria-hidden="true" />
          <div class="dz-title">Drag & drop .docx files here</div>
          <div class="dz-sub">or click to browse (multiple files supported)</div>
          
        <input
          type="file"
          id="fileInput"
          name="file"
          accept=".docx"
          multiple
          required
          hidden
        />
      </div>
  
      <ul id="fileList" class="file-list"></ul>
   
  </section>


  <section class="card rules-card">
       <div class="rules-cols">
        
            <!-- LEFT COLUMN -->
            <div>
              <div class="rules-title">Voice &amp; audience</div>
        
              <div class="rule-row">
                <input type="checkbox" id="allow_i" />
                <span class="info tt" data-tip="Allows for the use of personal pronouns like 'I', 'you', 'we', and 'our'." tabindex="0" aria-label="Rule explanation">i</span>
                <div class="rule-text">Allow personal pronouns</div>
              
              </div>
        
              <div class="rule-row">
                <input type="checkbox" id="allow_audience" />
                <span class="info tt" data-tip="It is only necessary to refer to the reader or the audience of a text when the reader or audience is known or referred to by the text itself, otherwise, students tend to make weak analysis, claiming an effect on a reader or audience without providing evidence." tabindex="0" aria-label="Rule explanation">i</span>
                <div class="rule-text">Allow references to the reader or audience</div>
                
              </div>
        
              <div class="rules-title" style="margin-top:14px;">Argument and evidence</div>
        
              <div id="closedThesisRow" class="rule-row">
                <input type="checkbox" id="enforce_closed_thesis" />
                <span class="info tt" data-tip="For literary analysis, a closed thesis will contain specified devices or strategies and a clearly stated argument." tabindex="0" aria-label="Rule explanation">i</span>

                <div class="rule-text">Require a closed thesis statement</div>
               
              </div>
        
              <div id="requireBodyEvidenceRow" class="rule-row">
                <input type="checkbox" id="require_body_evidence" />
                <span class="info tt" data-tip="For literary analysis, it is generally expected that the body paragraphs will contain quotations." tabindex="0" aria-label="Rule explanation">i</span>

                <div class="rule-text">Require quotations in body paragraphs</div>
                
              </div>
        
              <div class="rule-row">
                <input type="checkbox" id="allow_intro_quotes" />
                <span class="info tt" data-tip="Unless there is an analytic frame, generally quotations are avoided in the introduction." tabindex="0" aria-label="Rule explanation">i</span>

                <div class="rule-text">Allow quotations in the introduction</div>
                
              </div>
        
              <div class="rule-row">
                <input type="checkbox" id="allow_long_quotes" />
                <span class="info tt" data-tip="The recommended length for a quotation is five words or less." tabindex="0" aria-label="Rule explanation">i</span>

                <div class="rule-text">Allow long quotations</div>
                
              </div>
            </div>
        
            <!-- RIGHT COLUMN -->
            <div>
              <div class="rules-title">Style</div>
        
              <div class="rule-row">
                <input type="checkbox" id="allow_contractions" />
                <span class="info tt" data-tip="Contractions such as 'isn't' or 'can't' are not generally accepted in academic writing." tabindex="0" aria-label="Rule explanation">i</span>

                <div class="rule-text">Allow contractions</div>
               
              </div>
        
              <div class="rule-row">
                <input type="checkbox" id="allow_which" />
                <span class="info tt" data-tip="Stylistically, the term 'which' leads to convoluted expressions." tabindex="0" aria-label="Rule explanation">i</span>

                <div class="rule-text">Allow the word “which”</div>
               
              </div>
        
              <div class="rule-row">
                <input type="checkbox" id="disable_fact_rule" />
                <span class="info tt" data-tip="In literary analysis, it is rare to claim that anything is 'proven' or 'factual'." tabindex="0" aria-label="Rule explanation">i</span>

                <div class="rule-text">Allow “fact” and “prove”</div>
                
              </div>
        
              <div class="rule-row">
                <input type="checkbox" id="disable_weak_verbs" />
                <span class="info tt" data-tip="The verbs 'show' and 'use' will be flagged as weak verbs due to their overuse." tabindex="0" aria-label="Rule explanation">i</span>

                <div class="rule-text">Disregard weak verbs</div>
                
              </div>
        
              <div class="rule-row">
                <input type="checkbox" id="disable_human_rule" />
                <span class="info tt" data-tip="Avoid using the words 'human', 'people', 'everyone', or 'individual'." tabindex="0" aria-label="Rule explanation">i</span>

                <div class="rule-text">Allow vague references to "people"</div>
                
              </div>
        
              <div class="rule-row">
                <input type="checkbox" id="disable_vague_general_rule" />
                <span class="info tt" data-tip="Avoid overly general words like 'society', 'universe', 'reality', 'life', and 'truth'. If these terms are not made specific, they will be flagged." tabindex="0" aria-label="Rule explanation">i</span>

                <div class="rule-text">Allow vague terms</div>
                
              </div>
        
              <div class="rules-title" style="margin-top:14px;">Grammar</div>
        
              <div id="svaRow" class="rule-row">
                <input type="checkbox" id="enforce_sva_rule" />
                <span class="info tt" data-tip="Subject-verb agreement errors will be flagged." tabindex="0" aria-label="Rule explanation">i</span>
                <div class="rule-text">Check for subject-verb agreement</div>        
              </div>
        
              <div id="presentTenseRow" class="rule-row">
                <input type="checkbox" id="enforce_present_tense_rule" />
                <span class="info tt" data-tip="Checks for present tense in literary analysis, but will flag all past tense verbs." tabindex="0" aria-label="Rule explanation">i</span>

                <div class="rule-text">Check for present tense</div>
              
              </div>
        
              <div class="rule-row">
                <input type="checkbox" id="highlight_devices" />
                <span class="info tt" data-tip="Literary and rhetorical devices as well as modes of discourse will be highlighted in green." tabindex="0" aria-label="Rule explanation">i</span>

                <div class="rule-text">Highlight devices and strategies</div>
                
              </div>
            </div>
        
          </div>
        </section>
        
</form>
<div id="status" role="status" aria-live="polite"></div>
</main>

  
   


    

    

   



  <script>
    // ===== Supabase auth setup =====
    const SUPABASE_URL = "https://divdfodsdtfbdwoqvsfy.supabase.co";  // your project URL
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpdmRmb2RzZHRmYmR3b3F2c2Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MjU1OTksImV4cCI6MjA4MTAwMTU5OX0.fnm_9qX5DqdR0j6y-2mRRkwr8Icm1uRNPbUo6lqzock"; // anon / publishable key

    const { createClient } = supabase;
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const form = document.getElementById("markForm");
    const fileInput = document.getElementById("fileInput");
    const logoutBtn = document.getElementById("logoutBtn");

    logoutBtn.addEventListener("click", async () => {
      await supa.auth.signOut();
      window.location.replace("/signin.html");
});

    const statusEl = document.getElementById("status");

    // ===== Drag & drop wiring =====
const dropZone = document.getElementById("dropZone");
const fileList = document.getElementById("fileList");

function renderFileList(files) {
  fileList.innerHTML = "";
  if (!files || files.length === 0) return;

  for (const f of files) {
    const li = document.createElement("li");
    li.textContent = f.name;
    fileList.appendChild(li);
  }
}

function isDocx(file) {
  return file && /\.docx$/i.test(file.name || "");
}

function setFileInputFiles(fileArray) {
  const dt = new DataTransfer();
  for (const f of fileArray) dt.items.add(f);
  fileInput.files = dt.files;
  renderFileList(fileInput.files);
}

function addFilesToSelection(newFiles) {
  const existing = Array.from(fileInput.files || []);
  const incoming = Array.from(newFiles || []);

  const kept = existing.slice();

  const bad = incoming.filter(f => !isDocx(f));
  const good = incoming.filter(f => isDocx(f));

  if (bad.length) {
    statusEl.textContent = `Ignored ${bad.length} non-.docx file(s).`;
  }

  // Append new .docx files (and avoid duplicates by name+size)
  for (const f of good) {
    const dupe = kept.some(x => x.name === f.name && x.size === f.size);
    if (!dupe) kept.push(f);
  }

  setFileInputFiles(kept);
}

// Click / keyboard opens file picker
dropZone.addEventListener("click", () => fileInput.click());
dropZone.addEventListener("keydown", (e) => {
  if (e.key === "Enter" || e.key === " ") {
    e.preventDefault();
    fileInput.click();
  }
});

// Standard selection updates list
fileInput.addEventListener("change", () => {
  renderFileList(fileInput.files);
});

// Drag events
["dragenter", "dragover"].forEach(evt => {
  dropZone.addEventListener(evt, (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.add("dragover");
  });
});

["dragleave", "dragend"].forEach(evt => {
  dropZone.addEventListener(evt, (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.classList.remove("dragover");
  });
});

dropZone.addEventListener("drop", (e) => {
  e.preventDefault();
  e.stopPropagation();
  dropZone.classList.remove("dragover");

  if (e.dataTransfer && e.dataTransfer.files) {
    addFilesToSelection(e.dataTransfer.files);
  }
});

    
    async function refreshAuthUI() {
      const { data } = await supa.auth.getSession();
      const session = data.session;

      if (!session) {
        window.location.replace("/signin.html");
        return;
      }

      // logged in
      form.style.display = "grid";
    }

    
    // Initial UI state + listener
    refreshAuthUI();
    supa.auth.onAuthStateChange((_event, _session) => {
      refreshAuthUI();
    });

    // ===== Marker client code =====

    // Your deployed API endpoint
    const API_URL = "https://vysti-rules.onrender.com/mark";

    const modeSelect = document.getElementById("mode");
    const allowICheckbox = document.getElementById("allow_i");
    const allowAudienceCheckbox = document.getElementById("allow_audience");
    const enforceClosedThesisCheckbox = document.getElementById("enforce_closed_thesis");
    const requireBodyEvidenceCheckbox = document.getElementById("require_body_evidence");
    const allowIntroQuotesCheckbox = document.getElementById("allow_intro_quotes");
    const allowLongQuotesCheckbox = document.getElementById("allow_long_quotes");
    const allowContractionsCheckbox = document.getElementById("allow_contractions");
    const allowWhichCheckbox = document.getElementById("allow_which");
    const disableWeakVerbsCheckbox = document.getElementById("disable_weak_verbs");
    const disableFactRuleCheckbox = document.getElementById("disable_fact_rule");
    const highlightDevicesCheckbox = document.getElementById("highlight_devices");
    const disableHumanRuleCheckbox = document.getElementById("disable_human_rule");
    const disableVagueRuleCheckbox = document.getElementById("disable_vague_general_rule");
    const enforceSvaCheckbox = document.getElementById("enforce_sva_rule");
    const enforcePresentTenseCheckbox = document.getElementById("enforce_present_tense_rule");


    const modeHelp = document.getElementById("modeHelp");

    const title2Input = document.getElementById("title2");
    const title3Input = document.getElementById("title3");
    const title2Type = document.getElementById("title2_is_minor");
    const title3Type = document.getElementById("title3_is_minor");
    const title1Type = document.getElementById("title_is_minor");
    const title1Radios = Array.from(document.querySelectorAll('input[name="title1_type"]'));
    const title2Radios = Array.from(document.querySelectorAll('input[name="title2_type"]'));
    const title3Radios = Array.from(document.querySelectorAll('input[name="title3_type"]'));

    function syncRadioGroupToSelect(radios, selectEl) {
      if (!selectEl || !radios || radios.length === 0) return;

      // Initialize radios from whatever the select currently says
      const current = selectEl.value;
      radios.forEach(r => (r.checked = (r.value === current)));

      // On change, push radio value into the select
      radios.forEach(r => {
        r.addEventListener("change", (e) => {
          if (e.target.checked) selectEl.value = e.target.value;
        });
      });
    }

    syncRadioGroupToSelect(title1Radios, title1Type);
    syncRadioGroupToSelect(title2Radios, title2Type);
    syncRadioGroupToSelect(title3Radios, title3Type);


    // Per-mode defaults for the visible rule toggles
    const MODE_RULE_DEFAULTS = {
      textual_analysis: {
        allowI: false,
        allowAudience: false,
        enforceClosedThesis: true,
        requireBodyEvidence: true,
        allowIntroQuotes: false,
        allowLongQuotes: false,   // false = still enforce long-quote rule
        highlightDevices: true,
        allowContractions: false,
        allowWhich: false,  // false = still avoid "which" by default
        disableWeakVerbs: false, // false = keep marking weak verbs
        disableFactRule: false, // false = keep enforcing fact/proof/prove rule
        disableHumanRule: false,
        disableVagueGeneralRule: false,
        enforceSva: true,
        enforcePresentTense: true,
        description: ""
      },
      reader_response: {
        allowI: true,
        allowAudience: true,
        enforceClosedThesis: true,
        requireBodyEvidence: true,
        allowIntroQuotes: false,
        allowLongQuotes: false,   // false = still enforce long-quote rule
        highlightDevices: true,
        allowContractions: true,
        allowWhich: false,  // false = still avoid "which" by default
        disableWeakVerbs: false, // false = keep marking weak verbs
        disableFactRule: false, // false = keep enforcing fact/proof/prove rule
        disableHumanRule: false,
        disableVagueGeneralRule: false,
        enforceSva: true,
        enforcePresentTense: true,
        description: ""
      },
      analytic_frame: {
        allowI: false,
        allowAudience: false,
        enforceClosedThesis: true,
        requireBodyEvidence: true,
        allowIntroQuotes: true,
        allowLongQuotes: false,   // false = still enforce long-quote rule
        highlightDevices: true,
        allowContractions: false,
        allowWhich: false,  // false = still avoid "which" by default
        disableWeakVerbs: false, // false = keep marking weak verbs
        disableFactRule: false, // false = keep enforcing fact/proof/prove rule
        disableHumanRule: false,
        disableVagueGeneralRule: false,
        enforceSva: true,
        enforcePresentTense: true,
        description: ""
      },
      argumentation: {
        allowI: false,
        allowAudience: true,
        enforceClosedThesis: false,
        requireBodyEvidence: false,
        allowIntroQuotes: false,
        allowLongQuotes: false,   // false = still enforce long-quote rule
        highlightDevices: false,
        allowContractions: false,
        allowWhich: false,  // false = still avoid "which" by default
        disableWeakVerbs: false, // false = keep marking weak verbs
        disableFactRule: false, // false = keep enforcing fact/proof/prove rule
        disableHumanRule: false,
        disableVagueGeneralRule: false,
        enforceSva: true,
        enforcePresentTense: false,
        description: ""
      },
      foundation_1: {
        allowI: false,
        allowAudience: false,
        enforceClosedThesis: false,
        // requireBodyEvidence: false,
        allowIntroQuotes: false,
        allowLongQuotes: false,   // false = still enforce long-quote rule
        highlightDevices: true,
        allowContractions: false,
        allowWhich: false,  // false = still avoid "which" by default
        disableWeakVerbs: false, // false = keep marking weak verbs
        disableFactRule: false, // false = keep enforcing fact/proof/prove rule
        disableHumanRule: false,
        disableVagueGeneralRule: false,
        enforceSva: true,
        enforcePresentTense: true,
        description: ""
      },
      foundation_2: {
        allowI: false,
        allowAudience: false,
        enforceClosedThesis: true,
        // requireBodyEvidence: false,
        allowIntroQuotes: false,
        allowLongQuotes: false,   // false = still enforce long-quote rule
        highlightDevices: true,
        allowContractions: false,
        allowWhich: false,  // false = still avoid "which" by default
        disableWeakVerbs: false, // false = keep marking weak verbs
        disableFactRule: false, // false = keep enforcing fact/proof/prove rule
        disableHumanRule: false,
        disableVagueGeneralRule: false,
        enforceSva: true,
        enforcePresentTense: true,
        description: ""
      },
      foundation_3: {
        allowI: false,
        allowAudience: false,
        enforceClosedThesis: true,
        // requireBodyEvidence: false,
        allowIntroQuotes: false,
        allowLongQuotes: false,   // false = still enforce long-quote rule
        highlightDevices: true,
        allowContractions: false,
        allowWhich: false,  // false = still avoid "which" by default
        disableWeakVerbs: false, // false = keep marking weak verbs
        disableFactRule: false, // false = keep enforcing fact/proof/prove rule
        disableHumanRule: false,
        disableVagueGeneralRule: false,
        enforceSva: true,
        enforcePresentTense: true,
        description: ""
      },
      foundation_4: {
        allowI: false,
        allowAudience: false,
        enforceClosedThesis: true,
        // requireBodyEvidence: false,
        allowIntroQuotes: false,
        allowLongQuotes: false,   // false = still enforce long-quote rule
        highlightDevices: true,
        allowContractions: false,
        allowWhich: false,  // false = still avoid "which" by default
        disableWeakVerbs: false, // false = keep marking weak verbs
        disableFactRule: false, // false = keep enforcing fact/proof/prove rule
        disableHumanRule: false,
        disableVagueGeneralRule: false,
        enforceSva: true,
        enforcePresentTense: true,
        description: ""
      },
      foundation_5: {
        allowI: false,
        allowAudience: false,
        enforceClosedThesis: true,
        requireBodyEvidence: true,
        allowIntroQuotes: false,
        allowLongQuotes: false,   // false = still enforce long-quote rule
        highlightDevices: true,
        allowContractions: false,
        allowWhich: false,  // false = still avoid "which" by default
        disableWeakVerbs: false, // false = keep marking weak verbs
        disableFactRule: false, // false = keep enforcing fact/proof/prove rule
        disableHumanRule: false,
        disableVagueGeneralRule: false,
        enforceSva: true,
        enforcePresentTense: true,
        description: ""
      },
      foundation_6: {
        allowI: false,
        allowAudience: false,
        enforceClosedThesis: true,
        requireBodyEvidence: true,
        allowIntroQuotes: false,
        allowLongQuotes: false,   // false = still enforce long-quote rule
        highlightDevices: true,
        allowContractions: false,
        allowWhich: false,  // false = still avoid "which" by default
        disableWeakVerbs: false, // false = keep marking weak verbs
        disableFactRule: false, // false = keep enforcing fact/proof/prove rule
        disableHumanRule: false,
        disableVagueGeneralRule: false,
        enforceSva: true,
        enforcePresentTense: true,
        description: ""
      },
      peel_paragraph: {
        allowI: false,
        allowAudience: false,
        enforceClosedThesis: true,
        requireBodyEvidence: true,
        allowIntroQuotes: false,
        allowLongQuotes: false,   // false = still enforce long-quote rule
        highlightDevices: true,
        allowContractions: false,
        allowWhich: false,  // false = still avoid "which" by default
        disableWeakVerbs: false, // false = keep marking weak verbs
        disableFactRule: false, // false = keep enforcing fact/proof/prove rule
        disableHumanRule: false,
        disableVagueGeneralRule: false,
        enforceSva: true,
        enforcePresentTense: true,
        description: ""
      },
    };

    function applyModeDefaults() {
      const mode = modeSelect.value;
      const defaults = MODE_RULE_DEFAULTS[mode] || MODE_RULE_DEFAULTS["textual_analysis"];

      allowICheckbox.checked = !!defaults.allowI;
      allowAudienceCheckbox.checked = !!defaults.allowAudience;
      enforceClosedThesisCheckbox.checked = !!defaults.enforceClosedThesis;
      requireBodyEvidenceCheckbox.checked = !!defaults.requireBodyEvidence;
      allowIntroQuotesCheckbox.checked = !!defaults.allowIntroQuotes;
      allowLongQuotesCheckbox.checked = !!defaults.allowLongQuotes;
      allowContractionsCheckbox.checked = !!defaults.allowContractions;
      allowWhichCheckbox.checked = !!defaults.allowWhich;
      disableWeakVerbsCheckbox.checked = !!defaults.disableWeakVerbs;
      disableFactRuleCheckbox.checked = !!defaults.disableFactRule;
      disableHumanRuleCheckbox.checked = !!defaults.disableHumanRule;
      disableVagueRuleCheckbox.checked = !!defaults.disableVagueGeneralRule;
      enforceSvaCheckbox.checked = defaults.enforceSva !== false;
      enforcePresentTenseCheckbox.checked = defaults.enforcePresentTense !== false;

      // Hide present-tense toggle for Argumentation (and force it OFF so it can't "carry over")
      const hidePresentTense = (mode === "argumentation");
      document.getElementById("presentTenseRow").hidden = hidePresentTense;
      if (hidePresentTense) enforcePresentTenseCheckbox.checked = false;

      highlightDevicesCheckbox.checked = !!defaults.highlightDevices;

      if (modeHelp) {
        modeHelp.textContent = defaults.description;
      }
      const hideClosedThesis = (mode === "foundation_1");
      const hideEvidence = ["foundation_1","foundation_2","foundation_3","foundation_4"].includes(mode);

      document.getElementById("closedThesisRow").hidden = hideClosedThesis
      if (hideClosedThesis) enforceClosedThesisCheckbox.checked = false;

      document.getElementById("requireBodyEvidenceRow").hidden = hideEvidence;
      if (hideEvidence) requireBodyEvidenceCheckbox.checked = false;


    }

    modeSelect.addEventListener("change", applyModeDefaults);
    applyModeDefaults(); // initial state on load

    // Enable/disable Title 2/3 type pickers based on whether Title 2/3 has text
    function setRadiosDisabled(radios, disabled) {
  radios.forEach(r => (r.disabled = disabled));
}

function syncTypePickers() {
  const hasTitle2 = !!title2Input.value.trim();
  const hasTitle3 = !!title3Input.value.trim();

  title2Type.disabled = !hasTitle2;
  title3Type.disabled = !hasTitle3;

  setRadiosDisabled(title2Radios, !hasTitle2);
  setRadiosDisabled(title3Radios, !hasTitle3);
}


    ["input", "change"].forEach((evt) => {
      title2Input.addEventListener(evt, syncTypePickers);
      title3Input.addEventListener(evt, syncTypePickers);
    });
    syncTypePickers();

    function bindTitleTypeRadios(radioName, selectId) {
  const sel = document.getElementById(selectId);
  const radios = Array.from(document.querySelectorAll(`input[name="${radioName}"]`));
  if (!sel || radios.length === 0) return;

  // Ensure radio state matches current select value on load
  radios.forEach(r => r.checked = (r.value === sel.value));

  // When user changes radio, update the select value
  radios.forEach(r => {
    r.addEventListener("change", () => {
      if (r.checked) sel.value = r.value;
    });
  });
}

bindTitleTypeRadios("title1_type", "title_is_minor");


    form.addEventListener("submit", async (event) => {
      event.preventDefault();

            const files = fileInput.files;

      if (!files || files.length === 0) {
        statusEl.textContent = "Choose at least one .docx file.";
        return;
      }

      const mode = modeSelect.value;

      const author = document.getElementById("author").value.trim();
      const title = document.getElementById("title").value.trim();
      const titleIsMinor = document.getElementById("title_is_minor").value;

      const author2 = document.getElementById("author2").value.trim();
      const title2 = title2Input.value.trim();
      const title2IsMinor = title2Type.value;

      const author3 = document.getElementById("author3").value.trim();
      const title3 = title3Input.value.trim();
      const title3IsMinor = title3Type.value;

      const allowI = allowICheckbox.checked;
      const allowAudience = allowAudienceCheckbox.checked;
      const enforceClosedThesis = enforceClosedThesisCheckbox.checked;
      const requireBodyEvidence = requireBodyEvidenceCheckbox.checked;
      const allowIntroQuotes = allowIntroQuotesCheckbox.checked;
      const allowLongQuotes = allowLongQuotesCheckbox.checked;
      const allowContractions = allowContractionsCheckbox.checked;
      const allowWhich = allowWhichCheckbox.checked;
      const disableWeakVerbs = disableWeakVerbsCheckbox.checked;
      const disableFactRule = disableFactRuleCheckbox.checked;
      const disableHumanRule = disableHumanRuleCheckbox.checked;
      const disableVagueRule = disableVagueRuleCheckbox.checked;
      const highlightDevices = highlightDevicesCheckbox.checked;
      const enforceSva = enforceSvaCheckbox.checked;
      const enforcePresentTense = enforcePresentTenseCheckbox.checked;



      statusEl.textContent = `Processing ${files.length} file(s)...`;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        statusEl.textContent = `Processing ${i + 1} of ${files.length}: ${file.name}`;

        const formData = new FormData();
        formData.append("file", file);
        formData.append("mode", mode);

       


        if (author) formData.append("author", author);
        if (title) {
          formData.append("title", title);
          formData.append("text_is_minor_work", titleIsMinor);
        }

        if (author2) formData.append("author2", author2);
        if (title2) {
          formData.append("title2", title2);
          formData.append("text_is_minor_work_2", title2IsMinor);
        }
        if (author3) formData.append("author3", author3);
        if (title3) {
          formData.append("title3", title3);
          formData.append("text_is_minor_work_3", title3IsMinor);
        }

        // Rule settings: always send explicit booleans so backend matches the UI.
        formData.append("forbid_personal_pronouns", allowI ? "false" : "true");
        formData.append("forbid_audience_reference", allowAudience ? "false" : "true");
        formData.append("enforce_closed_thesis", enforceClosedThesis ? "true" : "false");
        formData.append("require_body_evidence", requireBodyEvidence ? "true" : "false");
        formData.append("allow_intro_summary_quotes", allowIntroQuotes ? "true" : "false");
        formData.append("enforce_intro_quote_rule", allowIntroQuotes ? "false" : "true");
        formData.append("enforce_long_quote_rule", allowLongQuotes ? "false" : "true");
        formData.append("enforce_contractions_rule", allowContractions ? "false" : "true");
        formData.append("enforce_which_rule", allowWhich ? "false" : "true");
        formData.append("enforce_weak_verbs_rule", disableWeakVerbs ? "false" : "true");
        formData.append("enforce_fact_proof_rule", disableFactRule ? "false" : "true");
        formData.append("enforce_human_people_rule", disableHumanRule ? "false" : "true");
        formData.append("enforce_vague_terms_rule", disableVagueRule ? "false" : "true");
        formData.append("enforce_sva_rule", enforceSva ? "true" : "false");
        formData.append("enforce_present_tense_rule", enforcePresentTense ? "true" : "false");
        formData.append("highlight_thesis_devices", highlightDevices ? "true" : "false");

        try {
          // Get current Supabase session token
          const { data } = await supa.auth.getSession();
          const session = data.session;
          if (!session) {
            statusEl.textContent = "You must be logged in to mark essays.";
            break;
          }

          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${session.access_token}`,
            },
            body: formData,
          });

          if (!response.ok) {
            const text = await response.text();
            console.error("Error response:", text);
            statusEl.textContent = `Error on ${file.name}: ${response.status}`;
            continue;
          }

          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");

          const baseName = file.name.replace(/\.docx$/i, "");
          a.href = url;
          a.download = `${baseName}_marked.docx`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (err) {
          console.error(err);
          statusEl.textContent = `Network error on ${file.name}`;
        }
      }

      statusEl.textContent = `Finished processing ${files.length} file(s).`;
    });
  </script>
</body>
</html>
