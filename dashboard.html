<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vysti Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            margin-top: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .nowrap {
            white-space: nowrap;
        }
        input[type="text"] {
            width: 180px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .name-input {
            width: 140px;
        }
        button {
            padding: 6px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .assign-btn {
            margin-top: 0;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            color: #666;
            font-style: italic;
            margin: 10px 0;
        }
        section {
            margin-bottom: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Vysti Dashboard</h1>
        
        <div id="authSection">
            <p>Please sign in to view your dashboard.</p>
            <button id="signInBtn">Sign In</button>
        </div>

        <section id="unassignedSection" style="display: none;">
            <h2>Unassigned</h2>
            <p class="status" id="unassignedStatus">Loadingâ€¦</p>
            <table>
                <thead>
                    <tr>
                        <th>File name</th>
                        <th>Guess (filename)</th>
                        <th>Guess (MLA)</th>
                        <th>Total issues</th>
                        <th>Student name</th>
                        <th>Assign</th>
                    </tr>
                </thead>
                <tbody id="unassignedTableBody">
                </tbody>
            </table>
        </section>

        <section id="usageSection" style="display: none;">
            <h2>Your marked essays</h2>
            <p class="status" id="usageStatus">Loadingâ€¦</p>
            <table>
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Student Name</th>
                        <th>Assignment</th>
                        <th>Mode</th>
                        <th>Total Labels</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody id="usageTableBody">
                </tbody>
            </table>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = "YOUR_SUPABASE_URL";
        const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
        const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // API base URL
        const API_BASE = "https://vysti-rules.onrender.com";

        // DOM references
        const authSection = document.getElementById("authSection");
        const unassignedSection = document.getElementById("unassignedSection");
        const usageSection = document.getElementById("usageSection");
        const signInBtn = document.getElementById("signInBtn");
        const usageStatus = document.getElementById("usageStatus");
        const usageTableBody = document.getElementById("usageTableBody");
        const unassignedStatus = document.getElementById("unassignedStatus");
        const unassignedTableBody = document.getElementById("unassignedTableBody");

        // Sign in handler
        signInBtn.addEventListener("click", async () => {
            const { data, error } = await supa.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.href
                }
            });
            if (error) {
                console.error("Sign in error:", error);
                alert("Sign in failed: " + error.message);
            }
        });

        // Check auth status on load
        async function refreshAuthUI() {
            const { data } = await supa.auth.getSession();
            const session = data.session;

            if (session) {
                authSection.style.display = "none";
                unassignedSection.style.display = "block";
                usageSection.style.display = "block";
                await loadUnassigned(session.user);
                await loadUsage(session.user);
            } else {
                authSection.style.display = "block";
                unassignedSection.style.display = "none";
                usageSection.style.display = "none";
            }
        }

        // Helper: guess student name from filename
        function guessFromFilename(fileName) {
            if (!fileName) return "â€”";
            // Remove extension
            let base = fileName.replace(/\.[^/.]+$/, "");
            // Split on [_\-.\s]+
            const parts = base.split(/[_\-.\s]+/);
            // Take first 2 "name-like" tokens (letters only) and Title-Case them
            const nameParts = [];
            for (const part of parts) {
                if (/^[a-zA-Z]+$/.test(part) && nameParts.length < 2) {
                    nameParts.push(part.charAt(0).toUpperCase() + part.slice(1).toLowerCase());
                }
            }
            return nameParts.length >= 2 ? nameParts.join(" ") : "â€”";
        }

        // Load usage/assigned essays
        async function loadUsage(user) {
            if (!user) return;
            usageStatus.textContent = "Loadingâ€¦";
            usageTableBody.innerHTML = "";

            const { data } = await supa.auth.getSession();
            const session = data.session;
            if (!session) {
                usageStatus.textContent = "Please sign in.";
                return;
            }

            try {
                // Select minimal columns needed, including id and file_name
                const { data: rows, error } = await supa
                    .from("mark_events")
                    .select("id, created_at, file_name, student_name, assignment_name, mode, total_labels")
                    .eq("user_id", user.id)
                    .not("student_name", "is", null)
                    .order("created_at", { ascending: false })
                    .limit(100);

                if (error) {
                    console.error("Usage error:", error);
                    usageStatus.textContent = "Error loading essays: " + error.message;
                    return;
                }

                if (!rows || rows.length === 0) {
                    usageStatus.textContent = "No marked essays yet.";
                    return;
                }

                usageStatus.textContent = `Showing ${rows.length} essay(s).`;

                for (const row of rows) {
                    const tr = document.createElement("tr");

                    const fileCell = document.createElement("td");
                    fileCell.textContent = row.file_name || "â€”";
                    tr.appendChild(fileCell);

                    const studentCell = document.createElement("td");
                    studentCell.textContent = row.student_name || "â€”";
                    tr.appendChild(studentCell);

                    const assignmentCell = document.createElement("td");
                    assignmentCell.textContent = row.assignment_name || "â€”";
                    tr.appendChild(assignmentCell);

                    const modeCell = document.createElement("td");
                    modeCell.textContent = row.mode || "â€”";
                    tr.appendChild(modeCell);

                    const totalCell = document.createElement("td");
                    totalCell.className = "nowrap";
                    totalCell.textContent = (row.total_labels != null) ? row.total_labels : "â€”";
                    tr.appendChild(totalCell);

                    const dateCell = document.createElement("td");
                    dateCell.className = "nowrap";
                    if (row.created_at) {
                        const date = new Date(row.created_at);
                        dateCell.textContent = date.toLocaleDateString() + " " + date.toLocaleTimeString();
                    } else {
                        dateCell.textContent = "â€”";
                    }
                    tr.appendChild(dateCell);

                    usageTableBody.appendChild(tr);
                }
            } catch (e) {
                console.error(e);
                usageStatus.textContent = "Network error loading essays.";
            }
        }

        // Load unassigned essays
        async function loadUnassigned(user) {
            if (!user) return;
            unassignedStatus.textContent = "Loadingâ€¦";
            unassignedTableBody.innerHTML = "";

            const { data } = await supa.auth.getSession();
            const session = data.session;
            if (!session) {
                unassignedStatus.textContent = "Please sign in.";
                return;
            }

            try {
                // Try to select columns including guess_filename and guess_mla
                // Fallback to minimal set if columns don't exist
                let selectColumns = "id, created_at, file_name, total_labels, student_name, guess_filename, guess_mla";
                let { data: rows, error } = await supa
                    .from("mark_events")
                    .select(selectColumns)
                    .eq("user_id", user.id)
                    .is("student_name", null)
                    .order("created_at", { ascending: false })
                    .limit(200);

                // If error due to missing columns, fallback to minimal set
                if (error && (error.message.includes("column") || error.code === "PGRST116")) {
                    selectColumns = "id, created_at, file_name, student_name, total_labels, assignment_name, mode";
                    const fallbackResp = await supa
                        .from("mark_events")
                        .select(selectColumns)
                        .eq("user_id", user.id)
                        .is("student_name", null)
                        .order("created_at", { ascending: false })
                        .limit(200);
                    rows = fallbackResp.data;
                    error = fallbackResp.error;
                }

                // Also check for empty string student_name and merge results
                if (!error) {
                    const { data: rowsEmpty, error: errEmpty } = await supa
                        .from("mark_events")
                        .select(selectColumns)
                        .eq("user_id", user.id)
                        .eq("student_name", "")
                        .order("created_at", { ascending: false })
                        .limit(200);
                    if (!errEmpty && rowsEmpty && rowsEmpty.length > 0) {
                        // Merge: combine and dedupe by id
                        const existingIds = new Set((rows || []).map(r => r.id));
                        const newRows = rowsEmpty.filter(r => !existingIds.has(r.id));
                        rows = (rows || []).concat(newRows);
                        // Re-sort by created_at desc
                        rows.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    }
                }

                if (error) {
                    console.error("Unassigned error:", error);
                    unassignedStatus.textContent = "Error loading unassigned: " + error.message;
                    return;
                }

                if (!rows || rows.length === 0) {
                    unassignedStatus.textContent = "No unassigned essays ðŸŽ‰";
                    return;
                }

                unassignedStatus.textContent = `Showing ${rows.length} unassigned essay(s).`;

                for (const row of rows) {
                    const tr = document.createElement("tr");

                    // File name
                    const fileCell = document.createElement("td");
                    fileCell.textContent = row.file_name || "â€”";
                    tr.appendChild(fileCell);

                    // Guess (filename)
                    const gFn = document.createElement("td");
                    const guessFromFn = row.guess_filename || guessFromFilename(row.file_name);
                    gFn.textContent = guessFromFn || "â€”";
                    tr.appendChild(gFn);

                    // Guess (MLA)
                    const gMla = document.createElement("td");
                    gMla.textContent = (row.guess_mla !== undefined && row.guess_mla !== null) ? row.guess_mla : "â€”";
                    tr.appendChild(gMla);

                    // Total issues
                    const totalCell = document.createElement("td");
                    totalCell.className = "nowrap";
                    totalCell.textContent = (row.total_labels != null) ? row.total_labels : "â€”";
                    tr.appendChild(totalCell);

                    // Student name input
                    const inputCell = document.createElement("td");
                    const inp = document.createElement("input");
                    inp.type = "text";
                    inp.className = "name-input";
                    inp.placeholder = "Student name";
                    // Prefill: guess_mla if present, else guess from filename, else ""
                    inp.value = row.guess_mla || (guessFromFn !== "â€”" ? guessFromFn : "") || "";
                    inputCell.appendChild(inp);
                    tr.appendChild(inputCell);

                    // Assign button
                    const actionCell = document.createElement("td");
                    actionCell.className = "nowrap";
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "assign-btn";
                    btn.textContent = "Assign";
                    
                    // Store row data for assignment
                    const rowId = row.id;
                    const rowFileName = row.file_name || "";
                    
                    btn.addEventListener("click", async () => {
                        const name = (inp.value || "").trim();
                        if (!name) {
                            alert("Please enter a student name.");
                            inp.focus();
                            return;
                        }
                        btn.disabled = true;
                        btn.textContent = "Assigningâ€¦";
                        
                        try {
                            const ok = await assignOne(rowId, name);
                            if (ok) {
                                tr.remove();
                                // Update status message
                                const remaining = unassignedTableBody.querySelectorAll("tr").length;
                                if (remaining === 0) {
                                    unassignedStatus.textContent = "No unassigned essays ðŸŽ‰";
                                } else {
                                    unassignedStatus.textContent = `Showing ${remaining} unassigned essay(s).`;
                                }
                                // Refresh the main usage list so assigned row appears there
                                await loadUsage(user);
                            } else {
                                btn.disabled = false;
                                btn.textContent = "Assign";
                            }
                        } catch (e) {
                            console.error("Assign error:", e);
                            btn.disabled = false;
                            btn.textContent = "Assign";
                            alert("Error assigning student name. Please try again.");
                        }
                    });
                    actionCell.appendChild(btn);
                    tr.appendChild(actionCell);

                    unassignedTableBody.appendChild(tr);
                }
            } catch (e) {
                console.error(e);
                unassignedStatus.textContent = "Network error loading unassigned: " + e.message;
            }
        }

        // Assign one essay to a student
        // Updates only mark_events.student_name for that row (no other writes)
        async function assignOne(id, student_name) {
            const { data } = await supa.auth.getSession();
            const session = data.session;
            if (!session) {
                alert("Session expired. Please sign in again.");
                return false;
            }

            try {
                const { data: result, error } = await supa
                    .from("mark_events")
                    .update({ student_name: student_name })
                    .eq("id", id);

                if (error) {
                    console.error("Assign error:", error);
                    
                    // Check for RLS/permission error
                    if (error.code === "42501" || error.message.includes("permission") || error.message.includes("RLS")) {
                        alert(`Permission error. Please ensure RLS policies allow UPDATE on mark_events.\n\n` +
                              `SQL to run in Supabase:\n` +
                              `-- Allow UPDATE on mark_events where auth.uid() = user_id\n` +
                              `CREATE POLICY "Users can update own mark_events"\n` +
                              `ON mark_events FOR UPDATE\n` +
                              `USING (auth.uid() = user_id)\n` +
                              `WITH CHECK (auth.uid() = user_id);`);
                    } else {
                        alert(`Assign failed: ${error.message}`);
                    }
                    return false;
                }
                
                return true;
            } catch (e) {
                console.error(e);
                alert("Network error while assigning: " + e.message);
                return false;
            }
        }

        // Initialize on page load
        refreshAuthUI();

        // Listen for auth state changes
        supa.auth.onAuthStateChange((event, session) => {
            if (event === "SIGNED_IN" || event === "SIGNED_OUT" || event === "TOKEN_REFRESHED") {
                refreshAuthUI();
            }
        });
    </script>
</body>
</html>

