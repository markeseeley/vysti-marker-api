<!-- DASHBOARD_VERSION: unassigned-v1 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vysti Marker – Usage Dashboard</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 16px;
      line-height: 1.5;
    }
    h1 { margin-bottom: 4px; }
    h2 { margin-top: 24px; }
    .subheading {
      margin-top: 0;
      font-size: 0.95rem;
      color: #555;
    }
    label { display: block; margin-top: 8px; }
    input, select { margin-top: 4px; padding: 4px 6px; width: 100%; max-width: 300px; }
    button {
      margin-top: 12px;
      padding: 6px 12px;
      cursor: pointer;
    }
    #authPanel {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
    }
    #authStatus {
      margin-top: 6px;
      font-size: 0.9rem;
      color: #555;
    }
    #usageStatus {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #555;
    }
    .filters {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 6px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      min-width: 150px;
    }
    .filter-group label {
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 0.9rem;
    }
    thead { background: #f5f5f5; }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    tr:nth-child(even) { background: #fafafa; }
    .nowrap { white-space: nowrap; }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }
    .link-row {
      margin-top: 8px;
      font-size: 0.9rem;
    }
    .analytics-section {
      margin-top: 24px;
      padding: 16px;
      background: #fafafa;
      border-radius: 6px;
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 16px;
    }
    .analytics-table {
      margin-top: 12px;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body>
  <div class="top-bar">
    <div>
      <h1>Vysti Marker – Usage Dashboard</h1>
      <p class="subheading">See how many yellow-label issues your students are getting on each assignment.</p>
    </div>
  </div>

  <section id="authPanel">
    <h2>Teacher sign in</h2>
    <label>
      Email
      <input type="email" id="authEmail" />
    </label>
    <label>
      Password
      <input type="password" id="authPassword" />
    </label>
    <div style="margin-top: 8px;">
      <button type="button" id="loginBtn">Log in</button>
      <button type="button" id="logoutBtn" style="display:none;">Log out</button>
    </div>
    <p id="authStatus"></p>
    <p class="link-row">
      <a href="index.html">← Back to Vysti Marker</a>
    </p>
  </section>

  <section id="usageSection" style="display:none;">
    <h2>Analytics Dashboard</h2>
    
    <div class="filters">
      <div class="filter-group">
        <label for="studentFilter">Student</label>
        <select id="studentFilter">
          <option value="">All Students</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="assignmentPrefixFilter">Assignment Prefix</label>
        <select id="assignmentPrefixFilter">
          <option value="">All Assignments</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="timeWindowFilter">Time Window</label>
        <select id="timeWindowFilter">
          <option value="30">Last 30 days</option>
          <option value="90">Last 90 days</option>
          <option value="all">All time</option>
        </select>
      </div>
    </div>

    <p id="usageStatus">Loading…</p>

    <!-- Progress by Assignment -->
    <div class="analytics-section">
      <h3>Progress by Assignment</h3>
      <div class="chart-container">
        <canvas id="assignmentChart"></canvas>
      </div>
      <table class="analytics-table" aria-label="Progress by assignment">
        <thead>
          <tr>
            <th>Assignment</th>
            <th class="nowrap">Total Labels</th>
            <th class="nowrap">Essays Marked</th>
          </tr>
        </thead>
        <tbody id="assignmentTableBody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </div>

    <!-- Top Labels -->
    <div class="analytics-section">
      <h3>Top Labels</h3>
      <div class="chart-container">
        <canvas id="labelsChart"></canvas>
      </div>
      <table class="analytics-table" aria-label="Top labels">
        <thead>
          <tr>
            <th>Label</th>
            <th class="nowrap">Count</th>
          </tr>
        </thead>
        <tbody id="labelsTableBody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </div>

    <!-- Recent Marked Essays -->
    <div class="analytics-section">
      <h3>Recent Marked Essays</h3>
      <table aria-label="Recent marked essays">
        <thead>
          <tr>
            <th class="nowrap">Date</th>
            <th>Student</th>
            <th>Assignment</th>
            <th>Mode</th>
            <th class="nowrap">Total labels</th>
          </tr>
        </thead>
        <tbody id="usageTableBody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </div>
  </section>

  <script>
    // ===== Supabase config – copy from index.html =====
    const SUPABASE_URL = "https://divdfodsdtfbdwoqvsfy.supabase.co";  // same as index.html
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpdmRmb2RzZHRmYmR3b3F2c2Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MjU1OTksImV4cCI6MjA4MTAwMTU5OX0.fnm_9qX5DqdR0j6y-2mRRkwr8Icm1uRNPbUo6lqzock"; // same as index.html

    const { createClient } = supabase;
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const authEmailInput = document.getElementById("authEmail");
    const authPasswordInput = document.getElementById("authPassword");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authStatus = document.getElementById("authStatus");

    const usageSection = document.getElementById("usageSection");
    const usageStatus = document.getElementById("usageStatus");
    const usageTableBody = document.getElementById("usageTableBody");
    const studentFilter = document.getElementById("studentFilter");
    const assignmentPrefixFilter = document.getElementById("assignmentPrefixFilter");
    const timeWindowFilter = document.getElementById("timeWindowFilter");
    const assignmentTableBody = document.getElementById("assignmentTableBody");
    const labelsTableBody = document.getElementById("labelsTableBody");

    let allData = [];
    let assignmentChart = null;
    let labelsChart = null;

    // Numeric-aware assignment sorting helper
    function extractAssignmentParts(assignmentName) {
      if (!assignmentName) return { prefix: "", number: 0 };
      // Match patterns like "Homework 2", "Foundation 03", "X 11", etc.
      const match = assignmentName.match(/^([^\d]+?)\s*(\d+)$/);
      if (match) {
        return {
          prefix: match[1].trim(),
          number: parseInt(match[2], 10)
        };
      }
      return { prefix: assignmentName, number: 0 };
    }

    function sortAssignments(assignments) {
      return assignments.sort((a, b) => {
        const aParts = extractAssignmentParts(a.name);
        const bParts = extractAssignmentParts(b.name);
        
        // If filtering by prefix, just sort by number
        const selectedPrefix = assignmentPrefixFilter.value;
        if (selectedPrefix && aParts.prefix === selectedPrefix && bParts.prefix === selectedPrefix) {
          return aParts.number - bParts.number;
        }
        
        // Otherwise, sort by prefix first, then number
        if (aParts.prefix !== bParts.prefix) {
          return aParts.prefix.localeCompare(bParts.prefix);
        }
        return aParts.number - bParts.number;
      });
    }

    async function refreshAuthUI() {
      const { data } = await supa.auth.getSession();
      const session = data.session;

      if (session && session.user) {
        authStatus.textContent = `Signed in as ${session.user.email}`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        usageSection.style.display = "block";
        loadUsage(session.user);
      } else {
        authStatus.textContent = "Please sign in to view your dashboard.";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        usageSection.style.display = "none";
      }
    }

    loginBtn.addEventListener("click", async () => {
      const email = authEmailInput.value.trim();
      const password = authPasswordInput.value.trim();
      authStatus.textContent = "Logging in...";
      const { error } = await supa.auth.signInWithPassword({ email, password });
      if (error) {
        authStatus.textContent = `Login error: ${error.message}`;
      } else {
        authStatus.textContent = "Logged in.";
        await refreshAuthUI();
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await supa.auth.signOut();
      authStatus.textContent = "Logged out.";
      usageSection.style.display = "none";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
    });

    supa.auth.onAuthStateChange((_event, _session) => {
      refreshAuthUI();
    });

    // ===== Load usage from mark_events for this teacher =====
    async function loadUsage(user) {
      if (!user) return;
      usageStatus.textContent = "Loading…";

      // Build query with time filter
      let query = supa
        .from("mark_events")
        .select("created_at, student_name, assignment_name, mode, total_labels, label_counts, issues")
        .eq("user_id", user.id);

      const timeWindow = timeWindowFilter.value;
      if (timeWindow !== "all") {
        const days = parseInt(timeWindow, 10);
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - days);
        query = query.gte("created_at", cutoffDate.toISOString());
      }

      const { data, error } = await query
        .order("created_at", { ascending: false })
        .limit(1000);

      if (error) {
        console.error("Error loading usage:", error);
        usageStatus.textContent = `Error loading data: ${error.message}`;
        usageTableBody.innerHTML = "";
        assignmentTableBody.innerHTML = "";
        labelsTableBody.innerHTML = "";
        return;
      }

      if (!data || data.length === 0) {
        usageStatus.textContent = "No essays marked yet.";
        usageTableBody.innerHTML = "";
        assignmentTableBody.innerHTML = "";
        labelsTableBody.innerHTML = "";
        return;
      }

      allData = data;
      updateFilters(data);
      applyFilters(data);
    }

    function updateFilters(data) {
      // Update student filter
      const students = [...new Set(data.map(r => r.student_name).filter(Boolean))].sort();
      studentFilter.innerHTML = '<option value="">All Students</option>';
      students.forEach(student => {
        const option = document.createElement("option");
        option.value = student;
        option.textContent = student;
        studentFilter.appendChild(option);
      });

      // Update assignment prefix filter
      const prefixes = new Set();
      data.forEach(row => {
        if (row.assignment_name) {
          const parts = extractAssignmentParts(row.assignment_name);
          if (parts.prefix) {
            prefixes.add(parts.prefix);
          }
        }
      });
      const sortedPrefixes = Array.from(prefixes).sort();
      assignmentPrefixFilter.innerHTML = '<option value="">All Assignments</option>';
      sortedPrefixes.forEach(prefix => {
        const option = document.createElement("option");
        option.value = prefix;
        option.textContent = prefix;
        assignmentPrefixFilter.appendChild(option);
      });
    }

    function applyFilters(data) {
      // Apply student filter
      let filtered = data;
      const selectedStudent = studentFilter.value;
      if (selectedStudent) {
        filtered = filtered.filter(r => r.student_name === selectedStudent);
      }

      // Apply assignment prefix filter
      const selectedPrefix = assignmentPrefixFilter.value;
      if (selectedPrefix) {
        filtered = filtered.filter(r => {
          if (!r.assignment_name) return false;
          const parts = extractAssignmentParts(r.assignment_name);
          return parts.prefix === selectedPrefix;
        });
      }

      usageStatus.textContent = `Showing ${filtered.length} of ${data.length} marked essays.`;

      // Render recent essays table
      renderRecentEssays(filtered.slice(0, 50));

      // Calculate and render analytics
      calculateAnalytics(filtered);
    }

    function renderRecentEssays(data) {
      usageTableBody.innerHTML = "";
      for (const row of data) {
        const tr = document.createElement("tr");

        const dateCell = document.createElement("td");
        dateCell.className = "nowrap";
        const d = new Date(row.created_at);
        dateCell.textContent = d.toLocaleDateString();
        tr.appendChild(dateCell);

        const studentCell = document.createElement("td");
        studentCell.textContent = row.student_name || "—";
        tr.appendChild(studentCell);

        const assignmentCell = document.createElement("td");
        assignmentCell.textContent = row.assignment_name || "—";
        tr.appendChild(assignmentCell);

        const modeCell = document.createElement("td");
        modeCell.textContent = row.mode || "—";
        tr.appendChild(modeCell);

        const labelsCell = document.createElement("td");
        labelsCell.className = "nowrap";
        labelsCell.textContent = row.total_labels != null ? row.total_labels : "—";
        tr.appendChild(labelsCell);

        usageTableBody.appendChild(tr);
      }
    }

    function calculateAnalytics(data) {
      // Progress by assignment
      const assignmentMap = new Map();
      data.forEach(row => {
        const assignmentName = row.assignment_name || "Unnamed";
        if (!assignmentMap.has(assignmentName)) {
          assignmentMap.set(assignmentName, {
            name: assignmentName,
            totalLabels: 0,
            count: 0
          });
        }
        const entry = assignmentMap.get(assignmentName);
        entry.totalLabels += row.total_labels || 0;
        entry.count += 1;
      });

      const assignments = Array.from(assignmentMap.values());
      const sortedAssignments = sortAssignments(assignments);
      renderAssignmentProgress(sortedAssignments);

      // Top labels
      const labelCounter = new Map();
      data.forEach(row => {
        if (row.label_counts && typeof row.label_counts === 'object') {
          Object.entries(row.label_counts).forEach(([label, count]) => {
            const currentCount = labelCounter.get(label) || 0;
            labelCounter.set(label, currentCount + (typeof count === 'number' ? count : parseInt(count, 10) || 0));
          });
        }
      });

      const topLabels = Array.from(labelCounter.entries())
        .map(([label, count]) => ({ label, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 20);
      renderTopLabels(topLabels);
    }

    function renderAssignmentProgress(assignments) {
      assignmentTableBody.innerHTML = "";
      assignments.forEach(assignment => {
        const tr = document.createElement("tr");
        
        const nameCell = document.createElement("td");
        nameCell.textContent = assignment.name;
        tr.appendChild(nameCell);

        const labelsCell = document.createElement("td");
        labelsCell.className = "nowrap";
        labelsCell.textContent = assignment.totalLabels;
        tr.appendChild(labelsCell);

        const countCell = document.createElement("td");
        countCell.className = "nowrap";
        countCell.textContent = assignment.count;
        tr.appendChild(countCell);

        assignmentTableBody.appendChild(tr);
      });

      // Update chart
      if (assignmentChart) {
        assignmentChart.destroy();
      }

      const ctx = document.getElementById("assignmentChart").getContext("2d");
      const selectedPrefix = assignmentPrefixFilter.value;
      const chartData = selectedPrefix 
        ? assignments.map(a => extractAssignmentParts(a.name).number)
        : assignments.map((a, i) => i + 1);
      
      assignmentChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: assignments.map(a => a.name),
          datasets: [{
            label: "Total Labels",
            data: assignments.map(a => a.totalLabels),
            borderColor: "rgb(75, 192, 192)",
            backgroundColor: "rgba(75, 192, 192, 0.2)",
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function renderTopLabels(labels) {
      labelsTableBody.innerHTML = "";
      labels.forEach(({ label, count }) => {
        const tr = document.createElement("tr");
        
        const labelCell = document.createElement("td");
        labelCell.textContent = label || "—";
        tr.appendChild(labelCell);

        const countCell = document.createElement("td");
        countCell.className = "nowrap";
        countCell.textContent = count;
        tr.appendChild(countCell);

        labelsTableBody.appendChild(tr);
      });

      // Update chart
      if (labelsChart) {
        labelsChart.destroy();
      }

      const ctx = document.getElementById("labelsChart").getContext("2d");
      labelsChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels.map(l => l.label),
          datasets: [{
            label: "Count",
            data: labels.map(l => l.count),
            backgroundColor: "rgba(54, 162, 235, 0.6)",
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // Add event listeners for filters
    studentFilter.addEventListener("change", () => applyFilters(allData));
    assignmentPrefixFilter.addEventListener("change", () => applyFilters(allData));
    timeWindowFilter.addEventListener("change", async () => {
      const { data } = await supa.auth.getSession();
      if (data && data.session) {
        loadUsage(data.session.user);
      }
    });

    // Initial load
    refreshAuthUI();
  </script>
</body>
</html>
