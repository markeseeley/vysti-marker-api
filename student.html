<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vysti Marker — Student Check</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/marker.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx-preview/dist/docx-preview.min.js"></script>
  <style>
    .text-details-toggle {
      margin-top: 12px;
      padding: 8px 0;
      font-size: 13px;
      font-weight: 600;
      color: var(--maroon);
      cursor: pointer;
      user-select: none;
    }
    .text-details-toggle:hover {
      text-decoration: underline;
    }
    .text-details-section {
      margin-top: 12px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      display: none;
    }
    .text-details-section.visible {
      display: block;
    }
    .title-type-block {
      margin-top: 12px;
    }
    .title-type-label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .title-type-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .type-option {
      cursor: pointer;
    }
    .type-head {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .type-name {
      font-weight: 600;
      font-size: 13px;
    }
    .title-type-block input[type="radio"] {
      width: 16px;
      height: 16px;
      accent-color: var(--maroon);
    }
    .assignment-tracker-block {
      margin-bottom: 18px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .assignment-tracker-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }
    .assignment-tracker-help {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .work-section {
      margin-top: 16px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .work-section.hidden {
      display: none;
    }
    .work-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
    }
    .add-work-btn {
      margin-top: 12px;
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--maroon);
      border-radius: 6px;
      color: var(--maroon);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .add-work-btn:hover {
      background: var(--maroon);
      color: #fff;
    }
    .detected-meta {
      margin-top: 12px;
      padding: 8px 12px;
      background: #e7f3ff;
      border-radius: 6px;
      font-size: 12px;
      color: #0066cc;
      display: none;
    }
    .detected-meta.visible {
      display: block;
    }
    .marked-preview-card {
      margin-top: 24px;
      grid-column: 1 / -1;
    }
    .marked-preview-container {
      max-height: 600px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      background: #fff;
    }
    .revision-practice-card {
      margin-top: 24px;
      grid-column: 1 / -1;
    }
    .issue-select-wrapper {
      margin-bottom: 16px;
    }
    .issue-explanation {
      margin-bottom: 16px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      font-size: 13px;
      color: var(--text);
    }
    .examples-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .example-item {
      margin-bottom: 20px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .example-sentence {
      font-size: 14px;
      color: var(--text);
      margin-bottom: 8px;
      font-style: italic;
    }
    .example-student {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .example-rewrite {
      width: 100%;
      min-height: 80px;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      margin-bottom: 8px;
    }
    .example-actions {
      display: flex;
      gap: 8px;
    }
    .example-btn {
      padding: 6px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: #fff;
      font-size: 12px;
      cursor: pointer;
    }
    .example-btn:hover {
      background: #f0f0f0;
    }
    .hidden-select {
      position: absolute;
      opacity: 0;
      pointer-events: none;
      width: 0;
      height: 0;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img src="/assets/logo.svg" alt="Vysti" />
    </div>
  
    <nav>
      <a href="/student.html" class="active">Student Check</a>
    </nav>
  
    <div class="actions">
      <button class="topbar-btn" id="switchModeBtn" type="button">Switch to Teacher Mode</button>
      <button class="topbar-btn" id="logoutBtn" type="button">Sign Out</button>
    </div>
  </header>

  <main class="page">
    <form id="studentForm" class="marker-grid" style="display:none;">
      <section class="card form-card">
        <label>
          Select assignment
          <select id="mode">
            <option value="textual_analysis">Textual analysis</option>
            <option value="peel_paragraph">Mini-essay paragraph</option>
            <option value="reader_response">Reader response</option>
            <option value="argumentation">Argumentation</option>
          </select>
        </label>

        <!-- Mode explainer card (single, dynamic) -->
        <div class="mode-card" id="modeCard">
          <div class="mode-card-header">
            <span class="mode-badge" id="modeBadge">Textual analysis</span>
            <span class="mode-tag" id="modeTag"></span>
          </div>

          <div class="mode-desc" id="modeDesc">
            A formal and academic essay of analysis with all Vysti Rules running.
          </div>

          <button type="button" class="mode-more" id="modeMoreBtn" aria-expanded="false">
            Want more details?
          </button>

          <div class="mode-details" id="modeDetails" hidden>
            <ul id="modeDetailsList"></ul>
          </div>
        </div>

        <label>
          Your name (optional)
          <input type="text" id="studentName" placeholder="e.g., John Smith" />
        </label>

        <div class="assignment-tracker-block">
          <div class="assignment-tracker-title">Assignment Tracker</div>
          <div class="assignment-tracker-help">Give the assignment a name to keep track of your work.</div>
          <label>
            Assignment name (optional)
            <input type="text" id="assignmentName" placeholder="e.g., Homework 01" />
          </label>
        </div>

        <div class="text-details-toggle" id="textDetailsToggle">
          Enter author and text titles ▼
        </div>

        <div class="text-details-section visible" id="textDetailsSection">
          <div class="work-section" id="work1Section">
            <div class="work-title">What did you write about?</div>
            <div id="metaConfirm" class="detected-meta"></div>
            <label>
              Who is the author?
              <input type="text" id="author" placeholder="Author's full name" />
            </label>

            <label>
              What is the title?
              <input type="text" id="title" placeholder="Title of the text" />
            </label>

            <div class="title-type-block">
              <div class="title-type-label">Title type</div>
              <div class="title-type-grid">
                <label class="type-option">
                  <span class="type-head">
                    <input type="radio" name="title_type" value="true" checked />
                    <span class="type-name">Minor work</span>
                    <span
                      class="type-info tt"
                      tabindex="0"
                      data-tip="Minor work = shorter pieces in quotation marks (poems, short stories, articles, songs, chapters, speeches, episodes)."
                    >i</span>
                  </span>
                </label>
                <label class="type-option">
                  <span class="type-head">
                    <input type="radio" name="title_type" value="false" />
                    <span class="type-name">Major work</span>
                    <span
                      class="type-info tt"
                      tabindex="0"
                      data-tip="Major work = longer works in italics (novels, plays, films, TV series, newspapers, journals, musical albums)."
                    >i</span>
                  </span>
                </label>
              </div>
              <select id="title_is_minor" class="hidden-select" aria-hidden="true" tabindex="-1">
                <option value="true" selected>Minor work</option>
                <option value="false">Major work</option>
              </select>
            </div>
          </div>

          <button type="button" class="add-work-btn" id="addWork2Btn">Add another</button>

          <div class="work-section hidden" id="work2Section">
            <div class="work-title">Work 2</div>
            <label>
              Who is the author?
              <input type="text" id="author2" placeholder="Author's full name" />
            </label>

            <label>
              What is the title?
              <input type="text" id="title2" placeholder="Title of the text" />
            </label>

            <div class="title-type-block">
              <div class="title-type-label">Title type</div>
              <div class="title-type-grid">
                <label class="type-option">
                  <span class="type-head">
                    <input type="radio" name="title2_type" value="true" checked />
                    <span class="type-name">Minor work</span>
                    <span
                      class="type-info tt"
                      tabindex="0"
                      data-tip="Minor work = shorter pieces in quotation marks (poems, short stories, articles, songs, chapters, speeches, episodes)."
                    >i</span>
                  </span>
                </label>
                <label class="type-option">
                  <span class="type-head">
                    <input type="radio" name="title2_type" value="false" />
                    <span class="type-name">Major work</span>
                    <span
                      class="type-info tt"
                      tabindex="0"
                      data-tip="Major work = longer works in italics (novels, plays, films, TV series, newspapers, journals, musical albums)."
                    >i</span>
                  </span>
                </label>
              </div>
              <select id="title2_is_minor" class="hidden-select" aria-hidden="true" tabindex="-1">
                <option value="true" selected>Minor work</option>
                <option value="false">Major work</option>
              </select>
            </div>
          </div>

          <button type="button" class="add-work-btn hidden" id="addWork3Btn">Add another</button>

          <div class="work-section hidden" id="work3Section">
            <div class="work-title">Work 3</div>
            <label>
              Who is the author?
              <input type="text" id="author3" placeholder="Author's full name" />
            </label>

            <label>
              What is the title?
              <input type="text" id="title3" placeholder="Title of the text" />
            </label>

            <div class="title-type-block">
              <div class="title-type-label">Title type</div>
              <div class="title-type-grid">
                <label class="type-option">
                  <span class="type-head">
                    <input type="radio" name="title3_type" value="true" checked />
                    <span class="type-name">Minor work</span>
                    <span
                      class="type-info tt"
                      tabindex="0"
                      data-tip="Minor work = shorter pieces in quotation marks (poems, short stories, articles, songs, chapters, speeches, episodes)."
                    >i</span>
                  </span>
                </label>
                <label class="type-option">
                  <span class="type-head">
                    <input type="radio" name="title3_type" value="false" />
                    <span class="type-name">Major work</span>
                    <span
                      class="type-info tt"
                      tabindex="0"
                      data-tip="Major work = longer works in italics (novels, plays, films, TV series, newspapers, journals, musical albums)."
                    >i</span>
                  </span>
                </label>
              </div>
              <select id="title3_is_minor" class="hidden-select" aria-hidden="true" tabindex="-1">
                <option value="true" selected>Minor work</option>
                <option value="false">Major work</option>
              </select>
            </div>
          </div>
        </div>

        <button class="primary-btn" id="checkBtn" type="submit" disabled>Check My Essay</button>
      </section>

      <section class="card upload-card">
        <label>Essay (.docx)</label>
        
        <div id="dropZone" class="drop-zone" tabindex="0" role="button" aria-label="Upload .docx file">
          <img class="dz-icon" src="/assets/cloud-upload.svg" alt="" aria-hidden="true" />
          <div class="dz-title">Drag & drop .docx file here</div>
          <div class="dz-sub">or click to browse</div>
          
          <input
            type="file"
            id="fileInput"
            name="file"
            accept=".docx"
            hidden
          />
        </div>

        <ul id="fileList" class="file-list"></ul>
        <button type="button" id="clearFileBtn" class="secondary-btn" style="display:none;">Clear file</button>
      </section>

      <section class="card rules-card">
        <div class="rules-cols">
          <div>
            <div class="rules-title">Results</div>
            <div id="statusArea" class="status-area" role="status" aria-live="polite"></div>

            <button id="downloadBtn" class="secondary-btn" type="button" style="display:none; margin-top:12px;">
              Download marked essay
            </button>
          </div>

          <div>
            <div class="rules-title">Next steps</div>
            <div style="font-size:13px; color: rgba(0,0,0,.70); line-height:18px;">
              After you download your marked draft, revise and re-run the checker.
              (We'll add in-page marked-essay preview + guided revisions next.)
            </div>
          </div>
        </div>
      </section>
    </form>

    <section class="card marked-preview-card" id="markedPreviewCard" style="display:none;">
      <h2 style="margin-bottom: 12px; font-size: 18px; font-weight: 700;">Marked Essay Preview</h2>
      <div id="markedPreview" class="marked-preview-container"></div>
    </section>

    <section class="card revision-practice-card" id="revisionPracticeCard" style="display:none;">
      <h2 style="margin-bottom: 12px; font-size: 18px; font-weight: 700;">Fix Your Most Common Issues</h2>
      <div class="issue-select-wrapper">
        <label>
          Select an issue to practice
          <select id="issueSelect">
            <option value="">Select an issue...</option>
          </select>
        </label>
      </div>
      <div id="issueExplanation" class="issue-explanation" style="display:none;"></div>
      <ul id="examplesList" class="examples-list"></ul>
      <button type="button" class="secondary-btn" id="downloadRevisionNotesBtn" style="margin-top: 16px; display:none;">Download revision notes</button>
    </section>

    <footer class="marker-footer" aria-label="Site footer">
      <div class="footer-copy">© 2025 Vysti Research. All rights reserved.</div>
      <img class="footer-logo" src="/assets/logo_black.png" alt="Vysti" />
    </footer>
  </main>

  <script>
    // ===== Supabase auth setup =====
    const SUPABASE_URL = "https://divdfodsdtfbdwoqvsfy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpdmRmb2RzZHRmYmR3b3F2c2Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MjU1OTksImV4cCI6MjA4MTAwMTU5OX0.fnm_9qX5DqdR0j6y-2mRRkwr8Icm1uRNPbUo6lqzock";

    const { createClient } = supabase;
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const form = document.getElementById("studentForm");
    const fileInput = document.getElementById("fileInput");
    const checkBtn = document.getElementById("checkBtn");
    const clearFileBtn = document.getElementById("clearFileBtn");
    const statusArea = document.getElementById("statusArea");
    const downloadBtn = document.getElementById("downloadBtn");
    const fileList = document.getElementById("fileList");
    const dropZone = document.getElementById("dropZone");
    const textDetailsToggle = document.getElementById("textDetailsToggle");
    const textDetailsSection = document.getElementById("textDetailsSection");
    const titleTypeRadios = Array.from(document.querySelectorAll('input[name="title_type"]'));
    const titleIsMinorSelect = document.getElementById("title_is_minor");
    const addWork2Btn = document.getElementById("addWork2Btn");
    const addWork3Btn = document.getElementById("addWork3Btn");
    const work2Section = document.getElementById("work2Section");
    const work3Section = document.getElementById("work3Section");
    const metaConfirm = document.getElementById("metaConfirm");
    const markedPreviewCard = document.getElementById("markedPreviewCard");
    const markedPreview = document.getElementById("markedPreview");
    const revisionPracticeCard = document.getElementById("revisionPracticeCard");
    const issueSelect = document.getElementById("issueSelect");
    const issueExplanation = document.getElementById("issueExplanation");
    const examplesList = document.getElementById("examplesList");
    const downloadRevisionNotesBtn = document.getElementById("downloadRevisionNotesBtn");
    const modeSelect = document.getElementById("mode");

    let selectedFile = null;
    let downloadUrl = null;
    let markedBlob = null;
    let currentMarkEvent = null;
    let pendingDetectedMeta = null;

    // ===== Mode explainer card =====
    const MODE_RULE_DEFAULTS = {
      textual_analysis: {
        description: "A formal and academic essay of analysis with all Vysti Rules running.",
        details: [
          "No first-person allowed or personal pronouns",
          "First sentence should state the author & title of the work.",
          "Requires a closed thesis statement.",
          "Requires quoted evidence in body paragraphs.",
          "Strict requirements on organization, evidence, and language.",
          "Aqua-blue highlights repetitive 'and', weak verbs, and unclarified antecedents",
          "Red strikethroughs forbidden terms.",
          "Green highlights devices and strategies."
        ]
      },
      peel_paragraph: {
        description: "One focused analytical paragraph following the Vysti Rules.",
        details: [
          "The first sentence should state the author & title of the work.",
          "The first sentence should include devices and/or strategies like a closed thesis",
          "No first-person allowed or personal pronouns",
          "Requires quoted evidence in the body of the paragraph.",
          "Strict requirements on organization, evidence, and language.",
          "Aqua-blue highlights repetitive 'and', weak verbs, and unclarified antecedents",
          "Red strikethroughs forbidden terms.",
          "Green highlights devices and strategies."
        ]
      },
      reader_response: {
        description: "More personal voice allowed, but still needs argument + evidence.",
        details: [
          "Allows first-person and personal pronouns",
          "Allows contractions and 'which'",
          "First sentence should state the author & title of the work.",
          "Requires a closed thesis statement.",
          "Requires quoted evidence in body paragraphs.",
          "Strict requirements on organization, evidence, and language.",
          "Aqua-blue highlights repetitive 'and', weak verbs, and unclarified antecedents",
          "Red strikethroughs forbidden terms.",
          "Green highlights devices and strategies."
        ]
      },
      argumentation: {
        description: "Argumentation is more open mode beyond textual analysis.",
        details: [
          "Allows for past tense.",
          "Allows first-person and personal pronouns",
          "Aqua-blue highlights repetitive 'and', weak verbs, and unclarified antecedents",
          "Red strikethroughs forbidden terms.",
        ]
      }
    };

    // Mode explainer elements
    const modeBadge = document.getElementById("modeBadge");
    const modeTagEl = document.getElementById("modeTag");
    const modeDesc = document.getElementById("modeDesc");
    const modeMoreBtn = document.getElementById("modeMoreBtn");
    const modeDetails = document.getElementById("modeDetails");
    const modeDetailsList = document.getElementById("modeDetailsList");

    function setModeExplainer(mode) {
      const cfg = MODE_RULE_DEFAULTS[mode] || MODE_RULE_DEFAULTS.textual_analysis;
      const label = modeSelect.options[modeSelect.selectedIndex]?.textContent || mode;

      if (modeBadge) modeBadge.textContent = label;
      if (modeTagEl) modeTagEl.textContent = cfg.tag || "";
      if (modeDesc) modeDesc.textContent = cfg.description || "";

      if (modeDetailsList) {
        modeDetailsList.innerHTML = "";
        (cfg.details || []).forEach((item) => {
          const li = document.createElement("li");
          li.textContent = item;
          modeDetailsList.appendChild(li);
        });
      }

      const hasDetails = Array.isArray(cfg.details) && cfg.details.length > 0;
      if (modeMoreBtn) modeMoreBtn.hidden = !hasDetails;

      if (modeMoreBtn && modeDetails) {
        modeMoreBtn.setAttribute("aria-expanded", "false");
        modeDetails.hidden = true;
        modeMoreBtn.textContent = "Want more details?";
      }
    }

    // Expand / collapse once
    if (modeMoreBtn && modeDetails) {
      modeMoreBtn.addEventListener("click", () => {
        const expanded = modeMoreBtn.getAttribute("aria-expanded") === "true";
        modeMoreBtn.setAttribute("aria-expanded", String(!expanded));
        modeDetails.hidden = expanded;
        modeMoreBtn.textContent = expanded ? "Want more details?" : "Hide details";
      });
    }

    // Initialize mode explainer
    if (modeSelect) {
      setModeExplainer(modeSelect.value);
      modeSelect.addEventListener("change", () => {
        setModeExplainer(modeSelect.value);
      });
    }

    // ===== Auth + role guard =====
    async function refreshAuthUI() {
      const { data } = await supa.auth.getSession();
      const session = data.session;

      if (!session) {
        window.location.replace("/signin.html");
        return;
      }

      // Set role to student on successful auth guard
      localStorage.setItem("vysti_role", "student");

      // Logged in as student
      form.style.display = "grid";
    }

    // Initial auth check
    refreshAuthUI();
    supa.auth.onAuthStateChange((_event, _session) => {
      refreshAuthUI();
    });

    // ===== Switch mode handler =====
    const switchModeBtn = document.getElementById("switchModeBtn");
    if (switchModeBtn) {
      switchModeBtn.addEventListener("click", () => {
        localStorage.setItem("vysti_role", "teacher");
        window.location.href = "/index.html";
      });
    }

    // ===== Logout handler =====
    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener("click", async () => {
      await supa.auth.signOut();
      localStorage.removeItem("vysti_role");
      window.location.replace("/signin.html");
    });

    // ===== Title type radio sync =====
    titleTypeRadios.forEach(radio => {
      radio.addEventListener("change", (e) => {
        if (e.target.checked) {
          titleIsMinorSelect.value = e.target.value;
        }
      });
    });

    // Sync Work 2 radio
    const title2TypeRadios = Array.from(document.querySelectorAll('input[name="title2_type"]'));
    const title2IsMinorSelect = document.getElementById("title2_is_minor");
    title2TypeRadios.forEach(radio => {
      radio.addEventListener("change", (e) => {
        if (e.target.checked) {
          title2IsMinorSelect.value = e.target.value;
        }
      });
    });

    // Sync Work 3 radio
    const title3TypeRadios = Array.from(document.querySelectorAll('input[name="title3_type"]'));
    const title3IsMinorSelect = document.getElementById("title3_is_minor");
    title3TypeRadios.forEach(radio => {
      radio.addEventListener("change", (e) => {
        if (e.target.checked) {
          title3IsMinorSelect.value = e.target.value;
        }
      });
    });

    // ===== Progressive disclosure for Work 2/3 =====
    addWork2Btn.addEventListener("click", () => {
      work2Section.classList.remove("hidden");
      addWork2Btn.classList.add("hidden");
      addWork3Btn.classList.remove("hidden");
    });

    addWork3Btn.addEventListener("click", () => {
      work3Section.classList.remove("hidden");
      addWork3Btn.classList.add("hidden");
    });

    // ===== Text details toggle =====
    textDetailsToggle.addEventListener("click", () => {
      const isVisible = textDetailsSection.classList.contains("visible");
      if (isVisible) {
        textDetailsSection.classList.remove("visible");
        textDetailsToggle.textContent = "Enter author and text titles ▼";
      } else {
        textDetailsSection.classList.add("visible");
        textDetailsToggle.textContent = "Enter author and text titles ▲";
      }
    });

    // ===== File handling (single file only) =====
    function updateFileUI() {
      fileList.innerHTML = "";
      clearFileBtn.style.display = "none";
      
      if (selectedFile) {
        const li = document.createElement("li");
        li.textContent = selectedFile.name;
        fileList.appendChild(li);
        clearFileBtn.style.display = "block";
        checkBtn.disabled = false;
      } else {
        checkBtn.disabled = true;
      }
    }

    function clearFile() {
      selectedFile = null;
      fileInput.value = "";
      downloadUrl = null;
      markedBlob = null;
      downloadBtn.style.display = "none";
      statusArea.textContent = "";
      statusArea.className = "status-area";
      pendingDetectedMeta = null;
      metaConfirm.classList.remove("visible");
      metaConfirm.textContent = "";
      markedPreviewCard.style.display = "none";
      markedPreview.innerHTML = "";
      revisionPracticeCard.style.display = "none";
      issueSelect.innerHTML = '<option value="">Select an issue...</option>';
      issueExplanation.style.display = "none";
      examplesList.innerHTML = "";
      downloadRevisionNotesBtn.style.display = "none";
      currentMarkEvent = null;
      updateFileUI();
    }

    clearFileBtn.addEventListener("click", clearFile);

    // Click drop zone to open file picker
    dropZone.addEventListener("click", () => fileInput.click());

    dropZone.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        fileInput.click();
      }
    });

    // ===== Extract metadata from docx =====
    
    // Helper: Strip HTML tags and get plain text
    function stripTags(html) {
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || "";
    }
    
    // Helper: Normalize typography (curly quotes to straight quotes, non-breaking spaces, whitespace)
    function normalizeTypography(s) {
      return (s || "")
        .replace(/\u00A0/g, " ")
        .replace(/[""]/g, '"')
        .replace(/['']/g, "'")
        .replace(/\s+/g, " ")
        .trim();
    }
    
    // Helper: Normalize punctuation (curly quotes/apostrophes to straight ones, non-breaking spaces)
    function normalizePunct(s) {
      return (s || "")
        .replace(/[""]/g, '"')
        .replace(/['']/g, "'")
        .replace(/\u00A0/g, " ");
    }
    
    // Helper: Check if text has sentence-ending punctuation
    function hasSentenceEnd(text) {
      const t = normalizePunct(text).trim();
      return /[.!?]/.test(t);
    }
    
    // Helper: Check if text looks like a student essay-title header format
    function isEssayTitleHeaderLine(text) {
      const s = normalizeTypography(text);
      // "Quotation": Topic in Essay Title
      return /^"[^"]+"\s*:\s*.+/.test(s) && !hasSentenceEnd(s);
    }
    
    // Helper: Check if text looks like a header or title line (not an intro sentence)
    function isLikelyHeaderOrTitle(text) {
      const plainText = normalizeTypography(text);
      
      // First check: Skip student essay-title header format
      if (isEssayTitleHeaderLine(plainText)) {
        return true;
      }
      
      // 1) ANY paragraph without sentence-ending punctuation is likely a header/title
      // (unless it's extremely long, which suggests it's actual content)
      if (!hasSentenceEnd(plainText) && plainText.length <= 220) {
        return true;
      }
      
      // Keep the old check for backward compatibility with very short lines
      if (plainText.length <= 80 && !hasSentenceEnd(plainText)) {
        return true;
      }
      
      // 2) Looks like a date line
      if (/\b\d{1,2}\/\d{1,2}(\/\d{2,4})?\b/.test(plainText)) {
        return true;
      }
      const monthMatch = /\b(january|february|march|april|may|june|july|august|september|october|november|december)\b/i.test(plainText);
      if (monthMatch && /\d/.test(plainText)) {
        return true;
      }
      
      // 3) Looks like a teacher/class line
      if (/\b(Mr\.|Ms\.|Mrs\.|Dr\.|Professor|Prof\.)\b/i.test(plainText)) {
        return true;
      }
      
      // 4) Looks like a student name line (1-4 tokens, all Title Case, no punctuation, no digits)
      const tokens = plainText.split(/\s+/).filter(t => t.length > 0);
      if (tokens.length >= 1 && tokens.length <= 4) {
        const allTitleCase = tokens.every(t => /^[A-Z][a-z]*$/.test(t));
        const noDigits = !/\d/.test(plainText);
        const noSentencePunct = !/[.!?]/.test(plainText);
        if (allTitleCase && noDigits && noSentencePunct) {
          return true;
        }
      }
      
      // 5) Looks like "Homework / Essay / Paper / Assignment" heading
      if (/^(homework|essay|paper|assignment)\b/i.test(plainText)) {
        return true;
      }
      
      return false;
    }
    
    // Helper: Count words in text
    function countWords(text) {
      const words = (text || "").match(/\b[A-Za-z]+\b/g) || [];
      return words.length;
    }
    
    // Helper: Extract first sentence from plain text
    function getFirstSentence(text) {
      // Find the first sentence-ending punctuation that's not inside quotes
      let inQuotes = false;
      let quoteChar = null;
      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        if ((char === '"' || char === '"' || char === "'") && (i === 0 || text[i - 1] !== '\\')) {
          if (!inQuotes) {
            inQuotes = true;
            quoteChar = char;
          } else if (char === quoteChar) {
            inQuotes = false;
            quoteChar = null;
          }
        }
        if (!inQuotes && /[.!?]/.test(char)) {
          return text.slice(0, i + 1).trim();
        }
      }
      // Fallback: return first sentence by splitting
      const match = text.match(/^[^.!?]+[.!?]/);
      return match ? match[0].trim() : text.trim();
    }
    
    async function extractMetaFromDocx(file) {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.convertToHtml({ arrayBuffer });
        const html = result.value;
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        
        // Parse HTML into a list of paragraphs with metadata
        const paras = Array.from(doc.querySelectorAll("p"))
          .map(p => {
            const html = p.innerHTML.trim();
            const plain = stripTags(html).trim();
            return {
              html,
              plain,
              wordCount: countWords(plain)
            };
          })
          .filter(p => p.plain.length > 0);
        
        if (paras.length === 0) return null;
        
        // Find the intro paragraph using priority selection:
        // A) First paragraph that: NOT header/title AND has sentence end AND >= 8 words
        // B) First paragraph that: NOT header/title AND has sentence end AND >= 5 words
        // C) First paragraph that: NOT header/title (but still requires sentence end)
        let introParagraphHtml = null;
        let introParagraphPlain = null;
        
        // Priority A: >= 8 words with sentence end
        for (const para of paras) {
          if (isLikelyHeaderOrTitle(para.plain)) continue;
          if (hasSentenceEnd(para.plain) && para.wordCount >= 8) {
            introParagraphHtml = para.html;
            introParagraphPlain = para.plain;
            break;
          }
        }
        
        // Priority B: >= 5 words with sentence end
        if (!introParagraphHtml) {
          for (const para of paras) {
            if (isLikelyHeaderOrTitle(para.plain)) continue;
            if (hasSentenceEnd(para.plain) && para.wordCount >= 5) {
              introParagraphHtml = para.html;
              introParagraphPlain = para.plain;
              break;
            }
          }
        }
        
        // Priority C: Any non-header paragraph with sentence end
        if (!introParagraphHtml) {
          for (const para of paras) {
            if (isLikelyHeaderOrTitle(para.plain)) continue;
            if (hasSentenceEnd(para.plain)) {
              introParagraphHtml = para.html;
              introParagraphPlain = para.plain;
              break;
            }
          }
        }
        
        if (!introParagraphHtml || !introParagraphPlain) {
          return null;
        }
        
        // IMPORTANT: Split intro paragraph on <br> if present to isolate intro sentence
        // Mammoth sometimes outputs student title + intro sentence in the same <p>
        let introSentenceHtml = introParagraphHtml;
        let selectedSegmentPlain = introParagraphPlain;
        
        // Split into segments by <br>
        const frag = document.createElement("div");
        frag.innerHTML = introParagraphHtml;
        
        const segments = [];
        let buf = [];
        
        // Walk through child nodes and split on <br>
        frag.childNodes.forEach(node => {
          if (node.nodeName === "BR") {
            if (buf.length > 0) {
              segments.push(buf);
              buf = [];
            }
          } else {
            buf.push(node);
          }
        });
        if (buf.length > 0) {
          segments.push(buf);
        }
        
        // If we found segments (meaning there were <br> tags), try to pick the first real sentence
        if (segments.length > 1) {
          let selectedSegment = null;
          
          // Priority 1: First segment with sentence end AND >= 8 words
          for (const buf of segments) {
            const segDiv = document.createElement("div");
            buf.forEach(n => {
              try {
                segDiv.appendChild(n.cloneNode(true));
              } catch (e) {
                // Skip nodes that can't be cloned (e.g., some text nodes)
              }
            });
            const segHtml = segDiv.innerHTML.trim();
            const segPlain = stripTags(segHtml).trim();
            
            // Skip essay title header segments
            if (isEssayTitleHeaderLine(segPlain)) continue;
            if (isLikelyHeaderOrTitle(segPlain)) continue;
            
            const wc = countWords(segPlain);
            
            if (hasSentenceEnd(segPlain) && wc >= 8) {
              selectedSegment = { html: segHtml, plain: segPlain };
              break;
            }
          }
          
          // Priority 2: First segment with sentence end AND >= 5 words
          if (!selectedSegment) {
            for (const buf of segments) {
              const segDiv = document.createElement("div");
              buf.forEach(n => {
                try {
                  segDiv.appendChild(n.cloneNode(true));
                } catch (e) {
                  // Skip nodes that can't be cloned
                }
              });
              const segHtml = segDiv.innerHTML.trim();
              const segPlain = stripTags(segHtml).trim();
              
              // Skip essay title header segments
              if (isEssayTitleHeaderLine(segPlain)) continue;
              if (isLikelyHeaderOrTitle(segPlain)) continue;
              
              const wc = countWords(segPlain);
              
              if (hasSentenceEnd(segPlain) && wc >= 5) {
                selectedSegment = { html: segHtml, plain: segPlain };
                break;
              }
            }
          }
          
          // If we found a selected segment, use it
          if (selectedSegment) {
            introSentenceHtml = selectedSegment.html;
            selectedSegmentPlain = selectedSegment.plain;
          }
          // Otherwise, fallback to whole paragraph (already set above)
        }
        
        // Extract first sentence from the selected segment
        const firstSentencePlain = getFirstSentence(selectedSegmentPlain);
        const firstSentenceNorm = normalizeTypography(firstSentencePlain);
        
        let detectedTitle = null;
        let detectedAuthor = null;
        let isMinor = true;
        
        // Extract title from intro sentence segment ONLY (not from essay title line)
        const frag2 = document.createElement("div");
        frag2.innerHTML = introSentenceHtml;
        
        // Check for italic candidates (Major work) - take first italic from intro sentence
        const italics = frag2.querySelectorAll("em, i, span[style*='italic']");
        if (italics.length > 0) {
          const italicTexts = Array.from(italics)
            .map(el => (el.textContent || "").trim())
            .filter(Boolean);

          if (italicTexts.length) {
            italicTexts.sort((a, b) => b.length - a.length);
            detectedTitle = italicTexts[0];
            isMinor = false;
          }
        }
        
        // If no italics, check for quoted text (Minor work)
        if (!detectedTitle) {
          const quoted = Array.from(firstSentenceNorm.matchAll(/"([^"]+)"/g))
            .map(m => ({
              text: (m[1] || "").trim(),
              idx: m.index ?? 0
            }))
            .filter(x => x.text && x.text.length >= 2 && x.text.length <= 120);

          if (quoted.length) {
            // Prefer a quote that looks like a work title in context:
            // e.g., "essay "Title"", "article "Title"", "novel "Title"", etc.
            const workWords = /(essay|article|novel|poem|short story|story|play|film|movie|book|chapter|speech|song|album)\b/i;

            const hasNonQuestion = quoted.some(q => !q.text.includes("?"));

            function scoreCandidate(q) {
              const left = firstSentenceNorm.slice(Math.max(0, q.idx - 45), q.idx);
              let score = 0;

              if (workWords.test(left)) score += 10;         // strongest signal
              if (q.idx < firstSentenceNorm.length / 2) score += 2; // earlier is better

              // Questions are often quoted prompts, not titles (but allow if it's the only option)
              if (q.text.includes("?") && hasNonQuestion) score -= 6;

              return score;
            }

            quoted.sort((a, b) => scoreCandidate(b) - scoreCandidate(a) || a.idx - b.idx);

            detectedTitle = quoted[0].text;
            isMinor = true;
          }
        }
        
        // Extract author from first sentence
        // Pattern 1: "by Author Name"
        const byMatch = firstSentenceNorm.match(/\bby\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,3})\b/i);
        if (byMatch) {
          detectedAuthor = byMatch[1].trim();
        } else {
          // Pattern 2: "Author Name presents/argues/shows/etc."
          const verbMatch = firstSentenceNorm.match(/^([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,3})\s+(presents|argues|shows|reveals|suggests|demonstrates)\b/i);
          if (verbMatch) {
            detectedAuthor = verbMatch[1].trim();
          } else {
            // Pattern 3: "Author's" or "Author's Title" 
            // Fix: Support curly apostrophe ' as well as straight apostrophe '
            const possessiveMatch = firstSentenceNorm.match(/([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,5})(?:'s|'s)/);
            if (possessiveMatch) {
              detectedAuthor = possessiveMatch[1].trim();
            }
          }
        }
        
        // Fallback: Extract author using proper noun clustering if no author detected
        if (!detectedAuthor) {
          function cleanPossessive(tok) {
            return tok.replace(/('s|'s)$/, "");
          }
          
          function isNameToken(tok) {
            return /^[A-Z][a-z]+$/.test(tok) || /^[A-Z]$/.test(tok) || /^[A-Z]\.$/.test(tok) || /^[A-Z][a-z]+('s|'s)$/.test(tok);
          }
          
          function extractProperNounName(sentence, detectedTitle) {
            const toks = (sentence.match(/[A-Za-z''.]+/g) || []).filter(Boolean);
            const titleKey = (detectedTitle || "").toLowerCase().replace(/[^a-z]+/g, " ").trim();
            const titleWords = new Set(titleKey.split(/\s+/).filter(Boolean));
            
            const candidates = [];
            let run = [];
            
            for (const raw of toks) {
              const tok = cleanPossessive(raw);
              if (isNameToken(raw)) {
                run.push(tok);
                if (run.length > 5) run.shift();
              } else {
                if (run.length >= 2) candidates.push(run.slice());
                run = [];
              }
            }
            if (run.length >= 2) candidates.push(run.slice());
            
            // Filter out candidates that overlap heavily with title words
            const filtered = candidates
              .map(arr => arr.join(" "))
              .filter(name => {
                const words = name.toLowerCase().split(/\s+/);
                const overlap = words.filter(w => titleWords.has(w)).length;
                return overlap === 0;
              });
            
            if (filtered.length > 0) return filtered[0];
            return null;
          }
          
          const pn = extractProperNounName(firstSentenceNorm, detectedTitle);
          if (pn) detectedAuthor = pn;
        }
        
        return { title: detectedTitle, author: detectedAuthor, isMinor };
      } catch (error) {
        console.error("Error extracting metadata:", error);
        return null;
      }
    }

    // File selection
    fileInput.addEventListener("change", async (e) => {
      const files = e.target.files;
      if (files && files.length > 0) {
        selectedFile = files[0];
        updateFileUI();
        
        // Extract metadata and store for later (after Check My Essay)
        const meta = await extractMetaFromDocx(selectedFile);
        if (meta) {
          pendingDetectedMeta = meta;
          applyDetectedMetaAfterCheck();
        }
      }
    });

    // Drag & drop
    ["dragenter", "dragover"].forEach(evt => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add("dragover");
      });
    });

    ["dragleave", "dragend"].forEach(evt => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove("dragover");
      });
    });

    dropZone.addEventListener("drop", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove("dragover");

      if (e.dataTransfer && e.dataTransfer.files) {
        const files = Array.from(e.dataTransfer.files);
        const docxFile = files.find(f => /\.docx$/i.test(f.name));
        if (docxFile) {
          selectedFile = docxFile;
          // Update file input programmatically
          const dt = new DataTransfer();
          dt.items.add(docxFile);
          fileInput.files = dt.files;
          updateFileUI();
          
          // Extract metadata and store for later (after Check My Essay)
          const meta = await extractMetaFromDocx(selectedFile);
          if (meta) {
            pendingDetectedMeta = meta;
            applyDetectedMetaAfterCheck();
          }
        } else {
          statusArea.textContent = "Please upload a .docx file.";
          statusArea.className = "status-area error";
        }
      }
    });

    // ===== Form submission =====
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!selectedFile) {
        statusArea.textContent = "Please select a .docx file.";
        statusArea.className = "status-area error";
        return;
      }

      // Get session
      const { data: sessionData } = await supa.auth.getSession();
      if (!sessionData || !sessionData.session) {
        statusArea.textContent = "You must be logged in.";
        statusArea.className = "status-area error";
        return;
      }

      const mode = document.getElementById("mode").value;
      const studentName = document.getElementById("studentName").value.trim();
      const assignmentName = document.getElementById("assignmentName").value.trim();
      const author = document.getElementById("author").value.trim();
      const title = document.getElementById("title").value.trim();
      const textIsMinorWork = titleIsMinorSelect.value;
      
      // Work 2
      const author2 = document.getElementById("author2").value.trim();
      const title2 = document.getElementById("title2").value.trim();
      const title2IsMinor = document.getElementById("title2_is_minor").value;
      
      // Work 3
      const author3 = document.getElementById("author3").value.trim();
      const title3 = document.getElementById("title3").value.trim();
      const title3IsMinor = document.getElementById("title3_is_minor").value;

      // Build FormData
      const formData = new FormData();
      formData.append("file", selectedFile);
      formData.append("mode", mode);

      if (studentName) {
        formData.append("student_name", studentName);
      }
      if (assignmentName) {
        formData.append("assignment_name", assignmentName);
      }
      if (author) {
        formData.append("author", author);
      }
      if (title) {
        formData.append("title", title);
        formData.append("text_is_minor_work", textIsMinorWork);
      }
      
      // Work 2
      if (author2) {
        formData.append("author2", author2);
      }
      if (title2) {
        formData.append("title2", title2);
        formData.append("text_is_minor_work_2", title2IsMinor);
      }
      
      // Work 3
      if (author3) {
        formData.append("author3", author3);
      }
      if (title3) {
        formData.append("title3", title3);
        formData.append("text_is_minor_work_3", title3IsMinor);
      }

      // Update UI
      statusArea.textContent = "Uploading…";
      statusArea.className = "status-area";
      checkBtn.disabled = true;
      downloadBtn.style.display = "none";

      try {
        // Call API
        const API_URL = "https://vysti-rules.onrender.com/mark";
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${sessionData.session.access_token}`,
          },
          body: formData,
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
        }

        const blob = await response.blob();
        markedBlob = blob;
        downloadUrl = URL.createObjectURL(blob);
        
        const baseName = selectedFile.name.replace(/\.docx$/i, "");
        downloadBtn.onclick = () => {
          const a = document.createElement("a");
          a.href = downloadUrl;
          a.download = `${baseName}_marked.docx`;
          document.body.appendChild(a);
          a.click();
          a.remove();
        };

        // Render marked essay preview
        try {
          markedPreview.innerHTML = "";
          const buf = await blob.arrayBuffer();
          if (typeof docx !== "undefined" && docx.renderAsync) {
            await docx.renderAsync(buf, markedPreview, null, { inWrapper: true });
            markedPreviewCard.style.display = "block";
          } else {
            // Fallback: show message if docx-preview not loaded
            markedPreview.innerHTML = "<p>Preview not available. Please download the file to view.</p>";
            markedPreviewCard.style.display = "block";
          }
        } catch (previewError) {
          console.error("Error rendering preview:", previewError);
          markedPreview.innerHTML = "<p>Error rendering preview. Please download the file to view.</p>";
          markedPreviewCard.style.display = "block";
        }

        statusArea.textContent = "Done — preview below. Download is ready.";
        statusArea.className = "status-area success";
        downloadBtn.style.display = "block";
        
        // Apply detected meta after successful marking
        applyDetectedMetaAfterCheck();
        
        // Load revision practice data
        await loadRevisionPractice();

      } catch (error) {
        console.error("Error:", error);
        statusArea.textContent = `Error: ${error.message}`;
        statusArea.className = "status-area error";
      } finally {
        checkBtn.disabled = false;
      }
    });

    // ===== Apply detected meta after Check My Essay =====
    function applyDetectedMetaAfterCheck() {
      if (!pendingDetectedMeta) return;

      const meta = pendingDetectedMeta;
      const titleInput = document.getElementById("title");
      const authorInput = document.getElementById("author");

      // Apply only if empty (don't overwrite student edits)
      const titleWasEmpty = titleInput && !titleInput.value.trim();
      if (meta.author && authorInput && !authorInput.value.trim()) {
        authorInput.value = meta.author;
      }
      if (meta.title && titleInput && titleWasEmpty) {
        titleInput.value = meta.title;
      }

      // Apply type toggle only if we filled the title field (it was empty before)
      if (meta.title && titleWasEmpty) {
        if (meta.isMinor) {
          const minorRadio = document.querySelector('input[name="title_type"][value="true"]');
          if (minorRadio) minorRadio.checked = true;
          titleIsMinorSelect.value = "true";
        } else {
          const majorRadio = document.querySelector('input[name="title_type"][value="false"]');
          if (majorRadio) majorRadio.checked = true;
          titleIsMinorSelect.value = "false";
        }
      }

      // Show confirmation banner above the inputs
      const parts = [];
      if (meta.author) parts.push(`Author: ${meta.author}`);
      if (meta.title) parts.push(`Title: ${meta.title}`);
      parts.push(`Type: ${meta.isMinor ? "Minor work" : "Major work"}`);

      metaConfirm.textContent = `Is this information correct? Detected from first sentence: ${parts.join(" | ")}`;
      metaConfirm.classList.add("visible");

      // Ensure the section is open so the student sees it
      textDetailsSection.classList.add("visible");
      textDetailsToggle.textContent = "Enter author and text titles ▲";
    }

    // ===== Revision Practice =====
    // Handle issue selection (set up once)
    issueSelect.addEventListener("change", async (e) => {
      const selectedLabel = e.target.value;
      if (!selectedLabel) {
        issueExplanation.style.display = "none";
        examplesList.innerHTML = "";
        downloadRevisionNotesBtn.style.display = "none";
        return;
      }

      await loadIssueExamples(selectedLabel);
    });

    async function loadRevisionPractice() {
      const { data: sessionData } = await supa.auth.getSession();
      if (!sessionData || !sessionData.session || !selectedFile) {
        return;
      }

      try {
        // Get latest mark event for this user and file
        const { data: markEvents, error: markError } = await supa
          .from("mark_events")
          .select("label_counts, issues, created_at, file_name")
          .eq("user_id", sessionData.session.user.id)
          .eq("file_name", selectedFile.name)
          .order("created_at", { ascending: false })
          .limit(1);

        if (markError) {
          console.error("Error loading mark events:", markError);
          revisionPracticeCard.style.display = "block";
          issueSelect.innerHTML = '<option value="">Examples will appear here after marking.</option>';
          return;
        }

        if (!markEvents || markEvents.length === 0) {
          revisionPracticeCard.style.display = "block";
          issueSelect.innerHTML = '<option value="">Examples will appear here after marking.</option>';
          return;
        }

        currentMarkEvent = markEvents[0];
        const labelCounts = currentMarkEvent.label_counts || {};
        
        // Get top issues by count, then deduplicate
        const sortedLabels = Object.entries(labelCounts)
          .sort((a, b) => (b[1] || 0) - (a[1] || 0))
          .map(([label]) => String(label || "").trim())
          .filter(Boolean);

        // Deduplicate while preserving order
        const seen = new Set();
        const uniqueLabels = [];
        for (const lbl of sortedLabels) {
          if (seen.has(lbl)) continue;
          seen.add(lbl);
          uniqueLabels.push(lbl);
          if (uniqueLabels.length >= 8) break;
        }

        if (uniqueLabels.length === 0) {
          revisionPracticeCard.style.display = "block";
          issueSelect.innerHTML = '<option value="">Examples will appear here after marking.</option>';
          return;
        }

        // Populate dropdown
        issueSelect.innerHTML = '<option value="">Select an issue...</option>';
        uniqueLabels.forEach(label => {
          const option = document.createElement("option");
          option.value = label;
          option.textContent = label;
          issueSelect.appendChild(option);
        });

        revisionPracticeCard.style.display = "block";

      } catch (error) {
        console.error("Error loading revision practice:", error);
        revisionPracticeCard.style.display = "block";
        issueSelect.innerHTML = '<option value="">Examples will appear here after marking.</option>';
      }
    }

    async function loadIssueExamples(label) {
      const { data: sessionData } = await supa.auth.getSession();
      if (!sessionData || !sessionData.session || !selectedFile) {
        return;
      }

      try {
        // Get explanation from issues array
        const issues = currentMarkEvent?.issues || [];
        const issueData = issues.find(iss => iss.label === label);
        if (issueData && issueData.explanation) {
          issueExplanation.textContent = issueData.explanation;
          issueExplanation.style.display = "block";
        } else {
          issueExplanation.style.display = "none";
        }

        // Get examples from issue_examples
        const { data: examples, error } = await supa
          .from("issue_examples")
          .select("label, sentence, student_name")
          .eq("user_id", sessionData.session.user.id)
          .eq("file_name", selectedFile.name)
          .eq("label", label)
          .order("created_at", { ascending: false })
          .limit(10); // Fetch more to allow deduplication

        if (error) {
          console.error("Error loading examples:", error);
          examplesList.innerHTML = "<li>Error loading examples.</li>";
          return;
        }

        // Deduplicate examples by sentence text (trimmed)
        const uniq = [];
        const seenSent = new Set();
        for (const ex of (examples || [])) {
          const s = String(ex?.sentence || "").trim();
          if (!s) continue;
          if (seenSent.has(s)) continue;
          seenSent.add(s);
          uniq.push(ex);
          if (uniq.length >= 3) break;
        }

        examplesList.innerHTML = "";
        
        if (!uniq || uniq.length === 0) {
          examplesList.innerHTML = "<li>No examples available for this issue. Try fixing similar issues from other assignments.</li>";
          downloadRevisionNotesBtn.style.display = "none";
          return;
        }

        uniq.forEach((ex, idx) => {
          const li = document.createElement("li");
          li.className = "example-item";
          
          const sentenceDiv = document.createElement("div");
          sentenceDiv.className = "example-sentence";
          sentenceDiv.textContent = ex.sentence || "";
          
          const studentDiv = document.createElement("div");
          studentDiv.className = "example-student";
          studentDiv.textContent = `From: ${ex.student_name || "You"}`;
          
          const rewriteTextarea = document.createElement("textarea");
          rewriteTextarea.className = "example-rewrite";
          rewriteTextarea.placeholder = "Rewrite it here...";
          rewriteTextarea.setAttribute("data-example-idx", idx);
          
          const actionsDiv = document.createElement("div");
          actionsDiv.className = "example-actions";
          
          const copyExampleBtn = document.createElement("button");
          copyExampleBtn.className = "example-btn";
          copyExampleBtn.textContent = "Copy example";
          copyExampleBtn.onclick = () => {
            navigator.clipboard.writeText(ex.sentence || "").then(() => {
              copyExampleBtn.textContent = "Copied!";
              setTimeout(() => copyExampleBtn.textContent = "Copy example", 2000);
            });
          };
          
          const copyRewriteBtn = document.createElement("button");
          copyRewriteBtn.className = "example-btn";
          copyRewriteBtn.textContent = "Copy your rewrite";
          copyRewriteBtn.onclick = () => {
            navigator.clipboard.writeText(rewriteTextarea.value).then(() => {
              copyRewriteBtn.textContent = "Copied!";
              setTimeout(() => copyRewriteBtn.textContent = "Copy your rewrite", 2000);
            });
          };
          
          actionsDiv.appendChild(copyExampleBtn);
          actionsDiv.appendChild(copyRewriteBtn);
          
          li.appendChild(sentenceDiv);
          li.appendChild(studentDiv);
          li.appendChild(rewriteTextarea);
          li.appendChild(actionsDiv);
          
          examplesList.appendChild(li);
        });

        downloadRevisionNotesBtn.style.display = "block";
        downloadRevisionNotesBtn.onclick = () => {
          downloadRevisionNotes(label, uniq);
        };

      } catch (error) {
        console.error("Error loading issue examples:", error);
        examplesList.innerHTML = "<li>Error loading examples.</li>";
      }
    }

    function downloadRevisionNotes(label, examples) {
      const textareas = document.querySelectorAll(".example-rewrite");
      let content = `Revision Notes: ${label}\n\n`;
      
      examples.forEach((ex, idx) => {
        content += `Example ${idx + 1}:\n`;
        content += `Original: ${ex.sentence || ""}\n`;
        const rewrite = textareas[idx]?.value || "";
        if (rewrite) {
          content += `Your rewrite: ${rewrite}\n`;
        }
        content += `\n`;
      });
      
      const blob = new Blob([content], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `revision_notes_${label.replace(/\s+/g, "_")}.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Initial state
    updateFileUI();
  </script>
</body>
</html>
