<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vysti Marker — Ingest Marked Essays</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/marker.css">

  <!-- Supabase JS client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .ingest-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .ingest-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .ingest-table thead {
      background: #f5f5f5;
    }
    .ingest-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #e0e0e0;
    }
    .ingest-table td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    .ingest-table tr:last-child td {
      border-bottom: none;
    }
    .ingest-table input, .ingest-table select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .ingest-table input:focus, .ingest-table select:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 2px rgba(0,102,204,0.1);
    }
    .status-cell {
      font-size: 0.9rem;
    }
    .status-success {
      color: #28a745;
    }
    .status-error {
      color: #dc3545;
    }
    .status-pending {
      color: #6c757d;
    }
    .ingest-btn {
      margin-top: 20px;
      padding: 12px 24px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    .ingest-btn:hover {
      background: #0052a3;
    }
    .ingest-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .file-name-cell {
      font-weight: 500;
      white-space: normal;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img src="/assets/logo.svg" alt="Vysti" />
    </div>
  
    <nav>
      <a href="/progress.html">Dashboard</a>
      <a href="/index.html">Mark Assignments</a>
      <a href="/ingest.html" class="active">Ingest Marked Essays</a>
      <a href="/classes.html">Classes</a>
    </nav>
  
    <div class="actions">
      <button class="iconbtn" type="button" title="Notifications" aria-label="Notifications"></button>
      <img class="avatar" src="/assets/avatar.png" alt="Profile" />
      <button class="iconbtn" id="logoutBtn" type="button" title="Log out" aria-label="Log out"></button>
    </div>
  </header>

  <main class="page">
    <div class="ingest-container">
      <h1>Ingest Already-Marked Essays</h1>
      <p>Upload one or more <code>*_marked.docx</code> files to import their label counts into the dashboard.</p>

      <section class="card upload-card">
        <label>Marked Essays (.docx)</label>
        
        <div id="dropZone" class="drop-zone" tabindex="0" role="button" aria-label="Upload .docx files">
          <img class="dz-icon" src="/assets/cloud-upload.svg" alt="" aria-hidden="true" />
          <div class="dz-title">Drag & drop *_marked.docx files here</div>
          <div class="dz-sub">or click to browse</div>
          
          <input
            type="file"
            id="fileInput"
            name="file"
            accept=".docx"
            multiple
            hidden
          />
        </div>

        <button type="button" id="clearFilesBtn" class="secondary-btn" style="margin-top: 12px;">Clear uploaded files</button>
      </section>

      <table class="ingest-table" id="ingestTable" style="display: none;">
        <thead>
          <tr>
            <th>File</th>
            <th>Student Name</th>
            <th>Assignment</th>
            <th>Mode</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="ingestTableBody">
          <!-- rows injected by JS -->
        </tbody>
      </table>

      <button type="button" id="ingestBtn" class="ingest-btn" disabled>Ingest All</button>
      <div id="status" role="status" aria-live="polite" style="margin-top: 12px;"></div>
    </div>

    <footer class="marker-footer" aria-label="Site footer">
      <div class="footer-copy">© 2025 Vysti Research. All rights reserved.</div>
      <img class="footer-logo" src="/assets/logo_black.png" alt="Vysti" />
    </footer>
  </main>

  <script>
    // ===== Supabase auth setup =====
    const SUPABASE_URL = "https://divdfodsdtfbdwoqvsfy.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpdmRmb2RzZHRmYmR3b3F2c2Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MjU1OTksImV4cCI6MjA4MTAwMTU5OX0.fnm_9qX5DqdR0j6y-2mRRkwr8Icm1uRNPbUo6lqzock";

    const { createClient } = supabase;
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const API_URL = "https://vysti-rules.onrender.com/ingest_marked";

    const fileInput = document.getElementById("fileInput");
    const dropZone = document.getElementById("dropZone");
    const clearFilesBtn = document.getElementById("clearFilesBtn");
    const ingestBtn = document.getElementById("ingestBtn");
    const ingestTable = document.getElementById("ingestTable");
    const ingestTableBody = document.getElementById("ingestTableBody");
    const statusEl = document.getElementById("status");
    const logoutBtn = document.getElementById("logoutBtn");

    let fileData = []; // Array of {file, studentName, assignmentName, mode, status}

    // ===== Auth =====
    async function refreshAuthUI() {
      const { data } = await supa.auth.getSession();
      const session = data.session;

      if (!session) {
        window.location.replace("/signin.html");
        return;
      }
    }

    refreshAuthUI();
    supa.auth.onAuthStateChange((_event, _session) => {
      refreshAuthUI();
    });

    logoutBtn.addEventListener("click", async () => {
      await supa.auth.signOut();
      window.location.replace("/signin.html");
    });

    // ===== Filename parsing =====
    function parseFilename(filename) {
      // Strip .docx extension and trailing "_marked"
      let base = filename.replace(/\.docx$/i, "").replace(/_marked$/i, "");
      
      // Normalize underscores/hyphens to spaces
      base = base.replace(/[_-]/g, " ");
      
      // Try to extract assignment (e.g., "Homework 1", "HW01", "Foundation HW6", "X 2")
      // Support both assignment-first and student-first patterns
      // Handle compound names like "Foundation HW6", "High Level HW11"
      const assignmentPatterns = [
        // Pattern 1: "Foundation HW6", "High Level HW11" (prefix + HW + number)
        /((?:[A-Za-z]+\s+)+)(HW|Homework)\s*(\d+)/i,
        // Pattern 2: "Foundation 3", "Foundation 03" (prefix + number)
        /(Foundation|Found)\s*(\d+)/i,
        // Pattern 3: "HW6", "Homework 1" (just HW/Homework + number)
        /(HW|Homework)\s*(\d+)/i,
        // Pattern 4: Generic "X 2", "Essay 3", etc.
        /([A-Za-z]+)\s*(\d+)/,
      ];
      
      let assignmentName = "";
      let studentName = "";
      
      for (const pattern of assignmentPatterns) {
        const match = base.match(pattern);
        if (match) {
          const num = match[match.length - 1]; // Last capture group is always the number
          const numPadded = num.padStart(2, "0");
          
          // Build assignment name based on pattern
          if (match.length === 4) {
            // Pattern 1: prefix + HW/Homework + number
            const prefix = match[1].trim();
            const hwPart = match[2];
            const hwFormatted = hwPart.toUpperCase() === hwPart ? hwPart : 
              (hwPart.charAt(0).toUpperCase() + hwPart.slice(1).toLowerCase());
            assignmentName = `${prefix} ${hwFormatted} ${numPadded}`;
          } else if (match.length === 3) {
            // Pattern 2, 3, or 4: prefix + number
            const prefix = match[1];
            let prefixFormatted;
            if (prefix.toUpperCase() === prefix) {
              // Already all uppercase (e.g., "HW")
              prefixFormatted = prefix;
            } else {
              // Capitalize first letter, lowercase rest
              prefixFormatted = prefix.charAt(0).toUpperCase() + prefix.slice(1).toLowerCase();
            }
            assignmentName = prefixFormatted + " " + numPadded;
          }
          
          // Extract student name: prefer text AFTER the match, otherwise use BEFORE
          // This handles both patterns:
          // - "Foundation HW6 Wendi Zhou" → assignment: "Foundation HW06", student: "Wendi Zhou"
          // - "Wendi Zhou HW6" → assignment: "HW06", student: "Wendi Zhou"
          const afterMatch = base.substring(match.index + match[0].length).trim();
          const beforeMatch = base.substring(0, match.index).trim();
          
          if (afterMatch) {
            studentName = afterMatch;
          } else if (beforeMatch) {
            studentName = beforeMatch;
          }
          break;
        }
      }
      
      // If no assignment found, try to extract just a number at the end
      const numMatch = base.match(/(\d+)$/);
      if (!assignmentName && numMatch) {
        assignmentName = "Assignment " + numMatch[1].padStart(2, "0");
        const beforeNum = base.substring(0, numMatch.index).trim();
        if (beforeNum) {
          studentName = beforeNum;
        }
      }
      
      return { studentName, assignmentName };
    }

    // ===== File handling =====
    function isDocx(file) {
      return file && /\.docx$/i.test(file.name || "");
    }

    function addFiles(newFiles) {
      const incoming = Array.from(newFiles || []).filter(isDocx);
      
      for (const file of incoming) {
        // Check if already added
        if (fileData.some(fd => fd.file.name === file.name && fd.file.size === file.size)) {
          continue;
        }
        
        const { studentName, assignmentName } = parseFilename(file.name);
        
        fileData.push({
          file,
          studentName: studentName || "",
          assignmentName: assignmentName || "",
          mode: "imported_marked",
          status: "pending",
          result: null,
        });
      }
      
      renderTable();
      updateIngestButton();
    }

    function renderTable() {
      if (fileData.length === 0) {
        ingestTable.style.display = "none";
        return;
      }
      
      ingestTable.style.display = "table";
      ingestTableBody.innerHTML = "";
      
      for (let i = 0; i < fileData.length; i++) {
        const fd = fileData[i];
        const tr = document.createElement("tr");
        
        // File name
        const fileCell = document.createElement("td");
        fileCell.className = "file-name-cell";
        fileCell.title = fd.file.name;
        fileCell.textContent = fd.file.name;
        tr.appendChild(fileCell);
        
        // Student name (editable)
        const studentCell = document.createElement("td");
        const studentInput = document.createElement("input");
        studentInput.type = "text";
        studentInput.value = fd.studentName;
        studentInput.placeholder = "Student name";
        studentInput.addEventListener("input", (e) => {
          fd.studentName = e.target.value;
        });
        studentCell.appendChild(studentInput);
        tr.appendChild(studentCell);
        
        // Assignment (editable)
        const assignmentCell = document.createElement("td");
        const assignmentInput = document.createElement("input");
        assignmentInput.type = "text";
        assignmentInput.value = fd.assignmentName;
        assignmentInput.placeholder = "Assignment name";
        assignmentInput.addEventListener("input", (e) => {
          fd.assignmentName = e.target.value;
        });
        assignmentCell.appendChild(assignmentInput);
        tr.appendChild(assignmentCell);
        
        // Mode (dropdown)
        const modeCell = document.createElement("td");
        const modeSelect = document.createElement("select");
        modeSelect.innerHTML = `
          <option value="imported_marked" ${fd.mode === "imported_marked" ? "selected" : ""}>Imported Marked</option>
          <option value="textual_analysis" ${fd.mode === "textual_analysis" ? "selected" : ""}>Textual Analysis</option>
          <option value="peel_paragraph" ${fd.mode === "peel_paragraph" ? "selected" : ""}>PEEL Paragraph</option>
          <option value="reader_response" ${fd.mode === "reader_response" ? "selected" : ""}>Reader Response</option>
          <option value="analytic_frame" ${fd.mode === "analytic_frame" ? "selected" : ""}>Analytic Frame</option>
          <option value="argumentation" ${fd.mode === "argumentation" ? "selected" : ""}>Argumentation</option>
          <option value="foundation_1" ${fd.mode === "foundation_1" ? "selected" : ""}>Foundation 1</option>
          <option value="foundation_2" ${fd.mode === "foundation_2" ? "selected" : ""}>Foundation 2</option>
          <option value="foundation_3" ${fd.mode === "foundation_3" ? "selected" : ""}>Foundation 3</option>
          <option value="foundation_4" ${fd.mode === "foundation_4" ? "selected" : ""}>Foundation 4</option>
          <option value="foundation_5" ${fd.mode === "foundation_5" ? "selected" : ""}>Foundation 5</option>
        `;
        modeSelect.addEventListener("change", (e) => {
          fd.mode = e.target.value;
        });
        modeCell.appendChild(modeSelect);
        tr.appendChild(modeCell);
        
        // Status
        const statusCell = document.createElement("td");
        statusCell.className = "status-cell";
        if (fd.status === "success") {
          statusCell.className += " status-success";
          const totalLabels = fd.result?.total_labels || 0;
          const topLabels = fd.result?.label_counts ? Object.entries(fd.result.label_counts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([label, count]) => `${label} (${count})`)
            .join(", ") : "";
          statusCell.textContent = `✓ ${totalLabels} labels${topLabels ? `: ${topLabels}` : ""}`;
        } else if (fd.status === "error") {
          statusCell.className += " status-error";
          statusCell.textContent = `✗ ${fd.error || "Error"}`;
        } else if (fd.status === "processing") {
          statusCell.className += " status-pending";
          statusCell.textContent = "Processing...";
        } else {
          statusCell.className += " status-pending";
          statusCell.textContent = "Pending";
        }
        tr.appendChild(statusCell);
        
        ingestTableBody.appendChild(tr);
      }
    }

    function updateIngestButton() {
      ingestBtn.disabled = fileData.length === 0 || fileData.some(fd => fd.status === "processing");
    }

    // ===== Drag & drop =====
    dropZone.addEventListener("click", () => fileInput.click());
    dropZone.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        fileInput.click();
      }
    });

    fileInput.addEventListener("change", () => {
      addFiles(fileInput.files);
    });

    ["dragenter", "dragover"].forEach(evt => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add("dragover");
      });
    });

    ["dragleave", "dragend"].forEach(evt => {
      dropZone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove("dragover");
      });
    });

    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove("dragover");
      if (e.dataTransfer && e.dataTransfer.files) {
        addFiles(e.dataTransfer.files);
      }
    });

    clearFilesBtn.addEventListener("click", () => {
      fileData = [];
      fileInput.value = "";
      renderTable();
      updateIngestButton();
      statusEl.textContent = "";
    });

    // ===== Ingest button =====
    ingestBtn.addEventListener("click", async () => {
      if (fileData.length === 0) return;
      
      statusEl.textContent = `Processing ${fileData.length} file(s)...`;
      
      // Get session
      const { data } = await supa.auth.getSession();
      const session = data.session;
      if (!session) {
        statusEl.textContent = "You must be logged in to ingest files.";
        return;
      }
      
      // Process each file
      for (let i = 0; i < fileData.length; i++) {
        const fd = fileData[i];
        if (fd.status === "processing" || fd.status === "success") {
          continue; // Skip already processed files
        }
        
        fd.status = "processing";
        renderTable();
        updateIngestButton();
        
        try {
          const formData = new FormData();
          formData.append("file", fd.file);
          formData.append("student_name", fd.studentName || "");
          formData.append("assignment_name", fd.assignmentName || "");
          formData.append("mode", fd.mode);
          
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${session.access_token}`,
            },
            body: formData,
          });
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: `HTTP ${response.status}` }));
            throw new Error(errorData.error || `HTTP ${response.status}`);
          }
          
          const result = await response.json();
          fd.status = "success";
          fd.result = result;
        } catch (err) {
          fd.status = "error";
          fd.error = err.message || "Unknown error";
        }
        
        renderTable();
        updateIngestButton();
      }
      
      const successCount = fileData.filter(fd => fd.status === "success").length;
      statusEl.textContent = `Finished: ${successCount} of ${fileData.length} file(s) ingested successfully.`;
    });

    updateIngestButton();
  </script>
</body>
</html>

