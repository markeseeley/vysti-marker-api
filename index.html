<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vysti Marker</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 700px;
      margin: 40px auto;
      padding: 0 16px;
      line-height: 1.5;
    }
    label { display: block; margin-top: 12px; }
    input, select, button { margin-top: 4px; }
    button {
      margin-top: 20px;
      padding: 8px 16px;
      cursor: pointer;
    }
    #status {
      margin-top: 16px;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <h1>Vysti Marker</h1>

  <form id="markForm">
    <label>
      Essays (.docx)
      <input
        type="file"
        id="fileInput"
        name="file"
        accept=".docx"
        multiple
        required
      />
    </label>

    <label>
      Mode
      <select id="mode">
        <option value="textual_analysis">Textual analysis</option>
        <option value="intertextual_analysis">Intertextual analysis</option>
        <option value="reader_response">Reader response</option>
        <option value="analytic_frame">Analytic frame</option>
        <option value="argumentation">Argumentation</option>
        <option value="foundation_1">Foundation 1 – First sentence only</option>
        <option value="foundation_2">Foundation 2 – First sentence + thesis</option>
        <option value="foundation_3">Foundation 3 – Full introduction</option>
        <option value="foundation_4">Foundation 4 – Intro + topic sentence</option>
        <option value="foundation_5">Foundation 5 – Intro + body</option>
        <option value="foundation_6">Foundation 6 – Full essay</option>
        <option value="peel_paragraph">PEEL paragraph</option>
        <!-- add/remove as you like -->
      </select>
    </label>

    <label>
      Author
      <input type="text" id="author" />
    </label>

    <label>
      Title
      <input type="text" id="title" />
    </label>

    <label>
      Author 2
      <input type="text" id="author2" />
    </label>

    <label>
      Title 2
      <input type="text" id="title2" />
    </label>

    <label>
      Author 3
      <input type="text" id="author3" />
    </label>

    <label>
      Title 3
      <input type="text" id="title3" />
    </label>

    <button type="submit">Mark my essay(s)</button>
  </form>

  <div id="status"></div>

  <script>
    // Your deployed API
    const API_URL = "https://vysti-marker-api.onrender.com/mark";

    const form = document.getElementById("markForm");
    const fileInput = document.getElementById("fileInput");
    const statusEl = document.getElementById("status");

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      const files = fileInput.files;
      if (!files || files.length === 0) {
        statusEl.textContent = "Choose at least one .docx file.";
        return;
      }

      const mode = document.getElementById("mode").value;
      const author = document.getElementById("author").value.trim();
      const title = document.getElementById("title").value.trim();
      const author2 = document.getElementById("author2").value.trim();
      const title2 = document.getElementById("title2").value.trim();
      const author3 = document.getElementById("author3").value.trim();
      const title3 = document.getElementById("title3").value.trim();

      statusEl.textContent = `Processing ${files.length} file(s)...`;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        statusEl.textContent = `Processing ${i + 1} of ${files.length}: ${file.name}`;

        const formData = new FormData();
        formData.append("file", file);
        formData.append("mode", mode);
        if (author) formData.append("author", author);
        if (title) formData.append("title", title);
        if (author2) formData.append("author2", author2);
        if (title2) formData.append("title2", title2);
        if (author3) formData.append("author3", author3);
        if (title3) formData.append("title3", title3);

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const text = await response.text();
            console.error("Error response:", text);
            statusEl.textContent = `Error on ${file.name}: ${response.status}`;
            continue;
          }

          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");

          const baseName = file.name.replace(/\.docx$/i, "");
          a.href = url;
          a.download = `${baseName}_marked.docx`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (err) {
          console.error(err);
          statusEl.textContent = `Network error on ${file.name}`;
        }
      }

      statusEl.textContent = `Finished processing ${files.length} file(s).`;
    });
  </script>
</body>
</html>
