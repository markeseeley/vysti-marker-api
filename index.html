<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vysti Marker</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 700px;
      margin: 40px auto;
      padding: 0 16px;
      line-height: 1.5;
    }
    label { display: block; margin-top: 12px; }
    input, select, button { margin-top: 4px; }
    button {
      margin-top: 20px;
      padding: 8px 16px;
      cursor: pointer;
    }
    fieldset {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      margin-top: 16px;
    }
    legend {
      font-weight: 600;
      padding: 0 6px;
    }
    #status {
      margin-top: 16px;
      font-size: 0.95rem;
    }
    #modeHelp {
      margin-top: 6px;
      font-size: 0.9rem;
      color: #555;
    }
    fieldset p.help-text {
      margin-top: 4px;
      font-size: 0.85rem;
      color: #555;
    }
    .rules-group-title {
      margin-top: 10px;
      margin-bottom: 4px;
      font-size: 0.95rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>Vysti Marker</h1>

  <form id="markForm">
    <label>
      Essays (.docx)
      <input
        type="file"
        id="fileInput"
        name="file"
        accept=".docx"
        multiple
        required
      />
    </label>

    <label>
      Mode
      <select id="mode">
        <option value="textual_analysis">Textual analysis</option>
        <!-- Intertextual analysis removed; multiple works are supported via the fields below -->
        <option value="reader_response">Reader response</option>
        <option value="analytic_frame">Analytic frame</option>
        <option value="argumentation">Argumentation</option>
        <option value="foundation_1">Foundation 1 – First sentence only</option>
        <option value="foundation_2">Foundation 2 – First sentence + thesis</option>
        <option value="foundation_3">Foundation 3 – Full introduction</option>
        <option value="foundation_4">Foundation 4 – Intro + topic sentence</option>
        <option value="foundation_5">Foundation 5 – Intro + body</option>
        <option value="foundation_6">Foundation 6 – Full essay</option>
        <option value="peel_paragraph">PEEL paragraph</option>
      </select>
    </label>
    <p id="modeHelp"></p>

    <!-- Work 1 -->
    <fieldset>
      <legend>Work 1</legend>
      <label>
        Author
        <input type="text" id="author" />
      </label>

      <label>
        Title
        <input type="text" id="title" />
      </label>

      <label>
        Title type
        <select id="title_is_minor">
          <option value="true" selected>Minor work — in &quot;double quotes&quot;</option>
          <option value="false">Major work — italicized</option>
        </select>
      </label>
    </fieldset>

    <!-- Work 2 (optional) -->
    <fieldset>
      <legend>Work 2 (optional)</legend>
      <label>
        Author 2
        <input type="text" id="author2" />
      </label>

      <label>
        Title 2
        <input type="text" id="title2" />
      </label>

      <label>
        Title 2 type
        <select id="title2_is_minor" disabled>
          <option value="true" selected>Minor work — in &quot;double quotes&quot;</option>
          <option value="false">Major work — italicized</option>
        </select>
      </label>
    </fieldset>

    <!-- Work 3 (optional) -->
    <fieldset>
      <legend>Work 3 (optional)</legend>
      <label>
        Author 3
        <input type="text" id="author3" />
      </label>

      <label>
        Title 3
        <input type="text" id="title3" />
      </label>

      <label>
        Title 3 type
        <select id="title3_is_minor" disabled>
          <option value="true" selected>Minor work — in &quot;double quotes&quot;</option>
          <option value="false">Major work — italicized</option>
        </select>
      </label>
    </fieldset>

    <!-- Rule toggles -->
    <fieldset>
      <legend>Rule options (optional)</legend>
      <p class="help-text">
        Mode sets the defaults for this assignment. Use these switches to loosen or tighten rules.
      </p>

      <div class="rules-group-title">Voice &amp; audience</div>
      <label>
        <input type="checkbox" id="allow_i" />
        Allow first person (“I”, “we”, “our”) in this assignment
      </label>
      <label>
        <input type="checkbox" id="allow_audience" />
        Allow direct address to the reader or audience (“you”, “the reader”, “audience”)
      </label>

      <div class="rules-group-title">Thesis</div>
      <label>
        <input type="checkbox" id="no_closed_thesis" />
        Do <strong>not</strong> enforce a closed thesis statement
      </label>

      <div class="rules-group-title">Evidence &amp; quotations</div>
      <label>
        <input type="checkbox" id="no_body_evidence" />
        Do <strong>not</strong> require a quotation in every body paragraph
      </label>
      <label>
        <input type="checkbox" id="allow_intro_quotes" />
        Allow quotations in the introduction (except the thesis sentence)
      </label>

      <div class="rules-group-title">Style</div>
      <label>
        <input type="checkbox" id="allow_contractions" />
        Allow contractions (“don't”, “can't”, “it's”) outside quotations
      </label>
      <label>
        <input type="checkbox" id="highlight_devices" />
        Highlight rhetorical devices/strategies in green
      </label>
    </fieldset>

    <button type="submit">Mark my essay(s)</button>
  </form>

  <div id="status" role="status" aria-live="polite"></div>

  <script>
    // Your deployed API endpoint
    const API_URL = "https://vysti-marker-api.onrender.com/mark";

    const form = document.getElementById("markForm");
    const fileInput = document.getElementById("fileInput");
    const statusEl = document.getElementById("status");

    const modeSelect = document.getElementById("mode");
    const allowICheckbox = document.getElementById("allow_i");
    const allowAudienceCheckbox = document.getElementById("allow_audience");
    const noClosedThesisCheckbox = document.getElementById("no_closed_thesis");
    const noBodyEvidenceCheckbox = document.getElementById("no_body_evidence");
    const allowIntroQuotesCheckbox = document.getElementById("allow_intro_quotes");
    const allowContractionsCheckbox = document.getElementById("allow_contractions");
    const highlightDevicesCheckbox = document.getElementById("highlight_devices");    
    const modeHelp = document.getElementById("modeHelp");

    const title2Input = document.getElementById("title2");
    const title3Input = document.getElementById("title3");
    const title2Type  = document.getElementById("title2_is_minor");
    const title3Type  = document.getElementById("title3_is_minor");

    // Per‑mode defaults for the visible rule toggles
    const MODE_RULE_DEFAULTS = {
      textual_analysis: {
        allowI: false,
        allowAudience: false,
        noClosedThesis: false,
        noBodyEvidence: false,
        allowIntroQuotes: false,
        highlightDevices: true,
        allowContractions: false,
        description: "Textual analysis: formal mode, no first person, closed thesis required."
      },
      reader_response: {
        allowI: true,
        allowAudience: true,
        noClosedThesis: false,
        noBodyEvidence: false,
        allowIntroQuotes: false,
        highlightDevices: true,
        allowContractions: true,
        description: "Reader response: personal voice allowed; still expects a thesis by default."
      },
      analytic_frame: {
        allowI: false,
        allowAudience: false,
        noClosedThesis: false,
        noBodyEvidence: false,
        allowIntroQuotes: true,
        highlightDevices: true,
        allowContractions: false,
        description: "Analytic frame: multiple works allowed; quotations in the introduction are allowed."
      },
      argumentation: {
        allowI: false,
        allowAudience: true,
        noClosedThesis: true,
        noBodyEvidence: false,
        allowIntroQuotes: false,
        highlightDevices: false,
        allowContractions: false,
        description: "Argumentation: open thesis by default; looser thesis/topic alignment; direct address to the reader allowed."
      },
      foundation_1: {
        allowI: false,
        allowAudience: false,
        noClosedThesis: true,
        noBodyEvidence: true,
        allowIntroQuotes: false,
        allowContractions: false,
        description: "Foundation 1: first sentence only; closed thesis and body‑paragraph rules are off."
      },
      foundation_2: {
        allowI: false,
        allowAudience: false,
        noClosedThesis: false,
        noBodyEvidence: true,
        allowIntroQuotes: false,
        allowContractions: false,
        description: "Foundation 2: first sentence + closed thesis."
      },
      foundation_3: {
        allowI: false,
        allowAudience: false,
        noClosedThesis: false,
        noBodyEvidence: true,
        allowIntroQuotes: false,
        allowContractions: false,
        description: "Foundation 3: full introduction with closed thesis."
      },
      foundation_4: {
        allowI: false,
        allowAudience: false,
        noClosedThesis: false,
        noBodyEvidence: true,
        allowIntroQuotes: false,
        allowContractions: false,
        description: "Foundation 4: introduction + first body topic sentence."
      },
      foundation_5: {
        allowI: false,
        allowAudience: false,
        noClosedThesis: false,
        noBodyEvidence: false,
        allowIntroQuotes: false,
        allowContractions: false,
        description: "Foundation 5: introduction + body paragraphs."
      },
      foundation_6: {
        allowI: false,
        allowAudience: false,
        noClosedThesis: false,
        noBodyEvidence: false,
        allowIntroQuotes: false,
        allowContractions: false,
        description: "Foundation 6: full essay, full rule set."
      },
      peel_paragraph: {
        allowI: false,
        allowAudience: false,
        noClosedThesis: false,
        noBodyEvidence: false,
        allowIntroQuotes: false,
        allowContractions: false,
        description: "PEEL paragraph: single body paragraph with evidence."
      },
    };

    function applyModeDefaults() {
      const mode = modeSelect.value;
      const defaults = MODE_RULE_DEFAULTS[mode] || MODE_RULE_DEFAULTS["textual_analysis"];

      allowICheckbox.checked = !!defaults.allowI;
      allowAudienceCheckbox.checked = !!defaults.allowAudience;
      noClosedThesisCheckbox.checked = !!defaults.noClosedThesis;
      noBodyEvidenceCheckbox.checked = !!defaults.noBodyEvidence;
      allowIntroQuotesCheckbox.checked = !!defaults.allowIntroQuotes;
      allowContractionsCheckbox.checked = !!defaults.allowContractions;
      highlightDevicesCheckbox.checked = !!defaults.highlightDevices;


      if (modeHelp) {
        modeHelp.textContent = defaults.description;
      }
    }

    modeSelect.addEventListener("change", applyModeDefaults);
    applyModeDefaults(); // initial state on load

    // Enable/disable Title 2/3 type pickers based on whether Title 2/3 has text
    function syncTypePickers() {
      title2Type.disabled = !title2Input.value.trim();
      title3Type.disabled = !title3Input.value.trim();
    }

    ["input", "change"].forEach((evt) => {
      title2Input.addEventListener(evt, syncTypePickers);
      title3Input.addEventListener(evt, syncTypePickers);
    });
    syncTypePickers();

    form.addEventListener("submit", async (event) => {
      event.preventDefault();

      const files = fileInput.files;
      if (!files || files.length === 0) {
        statusEl.textContent = "Choose at least one .docx file.";
        return;
      }

      const mode = modeSelect.value;

      const author = document.getElementById("author").value.trim();
      const title = document.getElementById("title").value.trim();
      const titleIsMinor = document.getElementById("title_is_minor").value;

      const author2 = document.getElementById("author2").value.trim();
      const title2 = title2Input.value.trim();
      const title2IsMinor = title2Type.value;

      const author3 = document.getElementById("author3").value.trim();
      const title3 = title3Input.value.trim();
      const title3IsMinor = title3Type.value;

      const allowI = allowICheckbox.checked;
      const allowAudience = allowAudienceCheckbox.checked;
      const noClosedThesis = noClosedThesisCheckbox.checked;
      const noBodyEvidence = noBodyEvidenceCheckbox.checked;
      const allowIntroQuotes = allowIntroQuotesCheckbox.checked;
      const allowContractions = allowContractionsCheckbox.checked;
      const highlightDevices = highlightDevicesCheckbox.checked;


      statusEl.textContent = `Processing ${files.length} file(s)...`;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        statusEl.textContent = `Processing ${i + 1} of ${files.length}: ${file.name}`;

        const formData = new FormData();
        formData.append("file", file);
        formData.append("mode", mode);

        if (author) formData.append("author", author);
        if (title) {
          formData.append("title", title);
          formData.append("text_is_minor_work", titleIsMinor);
        }

        if (author2) formData.append("author2", author2);
        if (title2) {
          formData.append("title2", title2);
          formData.append("text_is_minor_work_2", title2IsMinor);
        }

        if (author3) formData.append("author3", author3);
        if (title3) {
          formData.append("title3", title3);
          formData.append("text_is_minor_work_3", title3IsMinor);
        }

        // Rule settings: always send explicit booleans so backend matches the UI.
        formData.append("forbid_personal_pronouns", allowI ? "false" : "true");
        formData.append("forbid_audience_reference", allowAudience ? "false" : "true");
        formData.append("enforce_closed_thesis", noClosedThesis ? "false" : "true");
        formData.append("require_body_evidence", noBodyEvidence ? "false" : "true");
        formData.append("allow_intro_summary_quotes", allowIntroQuotes ? "true" : "false");
        formData.append("enforce_intro_quote_rule", allowIntroQuotes ? "false" : "true");
        formData.append("enforce_contractions_rule", allowContractions ? "false" : "true");
        formData.append("highlight_thesis_devices", highlightDevices ? "true" : "false");


        try {
          const response = await fetch(API_URL, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            const text = await response.text();
            console.error("Error response:", text);
            statusEl.textContent = `Error on ${file.name}: ${response.status}`;
            continue;
          }

          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");

          const baseName = file.name.replace(/\.docx$/i, "");
          a.href = url;
          a.download = `${baseName}_marked.docx`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } catch (err) {
          console.error(err);
          statusEl.textContent = `Network error on ${file.name}`;
        }
      }

      statusEl.textContent = `Finished processing ${files.length} file(s).`;
    });
  </script>
</body>
</html>
