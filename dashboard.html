<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vysti Marker – Usage Dashboard</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 0 16px;
      line-height: 1.5;
    }
    h1 { margin-bottom: 4px; }
    h2 { margin-top: 24px; }
    .subheading {
      margin-top: 0;
      font-size: 0.95rem;
      color: #555;
    }
    label { display: block; margin-top: 8px; }
    input { margin-top: 4px; padding: 4px 6px; }
    button {
      margin-top: 12px;
      padding: 6px 12px;
      cursor: pointer;
    }
    #authPanel {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
    }
    #authStatus {
      margin-top: 6px;
      font-size: 0.9rem;
      color: #555;
    }
    #unassignedStatus, #usageStatus {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #555;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 0.9rem;
    }
    thead { background: #f5f5f5; }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      text-align: left;
      vertical-align: top;
    }
    tr:nth-child(even) { background: #fafafa; }
    .nowrap { white-space: nowrap; }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }
    .link-row {
      margin-top: 8px;
      font-size: 0.9rem;
    }
    .name-input { width: 160px; }
    .assign-btn { margin-top: 0; }
    .muted { color: #777; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="top-bar">
    <div>
      <h1>Vysti Marker – Usage Dashboard</h1>
      <p class="subheading">Assign student names to batch-marked essays (no parsing, no re-marking).</p>
    </div>
  </div>

  <section id="authPanel">
    <h2>Teacher sign in</h2>
    <label>
      Email
      <input type="email" id="authEmail" />
    </label>
    <label>
      Password
      <input type="password" id="authPassword" />
    </label>
    <div style="margin-top: 8px;">
      <button type="button" id="loginBtn">Log in</button>
      <button type="button" id="logoutBtn" style="display:none;">Log out</button>
    </div>
    <p id="authStatus"></p>
    <p class="link-row">
      <a href="index.html">← Back to Vysti Marker</a>
    </p>
  </section>

  <!-- NEW: Unassigned section -->
  <section id="unassignedSection" style="display:none;">
    <h2>Unassigned</h2>
    <p id="unassignedStatus">Loading…</p>

    <table aria-label="Unassigned essays">
      <thead>
        <tr>
          <th>File name</th>
          <th>Guess (filename)</th>
          <th>Guess (MLA)</th>
          <th class="nowrap">Total issues</th>
          <th>Student name</th>
          <th class="nowrap">Assign</th>
        </tr>
      </thead>
      <tbody id="unassignedTableBody">
        <!-- rows injected by JS -->
      </tbody>
    </table>
    <p class="muted" style="margin-top:8px;">
      This table only updates <code>mark_events.student_name</code>. No document parsing. No re-marking.
    </p>
  </section>

  <section id="usageSection" style="display:none;">
    <h2>Your marked essays</h2>
    <p id="usageStatus">Loading…</p>
    <table aria-label="Usage summary">
      <thead>
        <tr>
          <th class="nowrap">Date</th>
          <th>Student</th>
          <th>Assignment</th>
          <th>Mode</th>
          <th class="nowrap">Total labels</th>
        </tr>
      </thead>
      <tbody id="usageTableBody">
        <!-- rows injected by JS -->
      </tbody>
    </table>
  </section>

  <script>
    // ===== Supabase config – copy from index.html =====
    const SUPABASE_URL = "https://divdfodsdtfbdwoqvsfy.supabase.co";  // same as index.html
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpdmRmb2RzZHRmYmR3b3F2c2Z5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MjU1OTksImV4cCI6MjA4MTAwMTU5OX0.fnm_9qX5DqdR0j6y-2mRRkwr8Icm1uRNPbUo6lqzock"; // same as index.html

    const { createClient } = supabase;
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const authEmailInput = document.getElementById("authEmail");
    const authPasswordInput = document.getElementById("authPassword");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authStatus = document.getElementById("authStatus");

    const unassignedSection = document.getElementById("unassignedSection");
    const unassignedStatus = document.getElementById("unassignedStatus");
    const unassignedTableBody = document.getElementById("unassignedTableBody");

    const usageSection = document.getElementById("usageSection");
    const usageStatus = document.getElementById("usageStatus");
    const usageTableBody = document.getElementById("usageTableBody");

    function titleCaseWord(w) {
      if (!w) return "";
      return w.charAt(0).toUpperCase() + w.slice(1).toLowerCase();
    }

    // Guess "First Last" from file name: splits on _- . whitespace, takes first 2 alphabetic tokens
    function guessFromFilename(fileName) {
      if (!fileName) return "";
      const base = fileName.replace(/\.[^/.]+$/, ""); // remove extension
      const tokens = base.split(/[_\-.\s]+/).filter(Boolean);

      const picks = [];
      for (const t of tokens) {
        const cleaned = (t || "").replace(/[^A-Za-z]/g, "");
        if (cleaned.length >= 2) picks.push(cleaned);
        if (picks.length >= 2) break;
      }
      if (picks.length === 0) return "";
      return picks.map(titleCaseWord).join(" ");
    }

    async function refreshAuthUI() {
      const { data } = await supa.auth.getSession();
      const session = data.session;

      if (session && session.user) {
        authStatus.textContent = `Signed in as ${session.user.email}`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";

        unassignedSection.style.display = "block";
        usageSection.style.display = "block";

        // Load both tables
        loadUnassigned(session.user);
        loadUsage(session.user);
      } else {
        authStatus.textContent = "Please sign in to view your dashboard.";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";

        unassignedSection.style.display = "none";
        usageSection.style.display = "none";
      }
    }

    loginBtn.addEventListener("click", async () => {
      const email = authEmailInput.value.trim();
      const password = authPasswordInput.value.trim();
      authStatus.textContent = "Logging in...";
      const { error } = await supa.auth.signInWithPassword({ email, password });
      if (error) {
        authStatus.textContent = `Login error: ${error.message}`;
      } else {
        authStatus.textContent = "Logged in.";
        await refreshAuthUI();
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await supa.auth.signOut();
      authStatus.textContent = "Logged out.";
      unassignedSection.style.display = "none";
      usageSection.style.display = "none";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
    });

    supa.auth.onAuthStateChange((_event, _session) => {
      refreshAuthUI();
    });

    async function loadUnassigned(user) {
      if (!user) return;
      unassignedStatus.textContent = "Loading…";
      unassignedTableBody.innerHTML = "";

      // Try with guess columns; fallback if they don't exist.
      let data, error;

      ({ data, error } = await supa
        .from("mark_events")
        .select("id, created_at, file_name, total_labels, student_name, guess_filename, guess_mla")
        .eq("user_id", user.id)
        .order("created_at", { ascending: false })
        .limit(200)
      );

      if (error) {
        console.warn("Falling back to minimal columns:", error);
        ({ data, error } = await supa
          .from("mark_events")
          .select("id, created_at, file_name, total_labels, student_name")
          .eq("user_id", user.id)
          .order("created_at", { ascending: false })
          .limit(200)
        );
      }

      if (error) {
        console.error("Error loading unassigned:", error);
        unassignedStatus.textContent = `Error loading unassigned: ${error.message}`;
        return;
      }

      const rows = (data || []).filter(r => !r.student_name || r.student_name.trim() === "");
      if (rows.length === 0) {
        unassignedStatus.textContent = "No unassigned essays.";
        return;
      }

      unassignedStatus.textContent = `Showing ${rows.length} unassigned essays.`;

      for (const row of rows) {
        const tr = document.createElement("tr");

        const fileCell = document.createElement("td");
        fileCell.textContent = row.file_name || "—";
        tr.appendChild(fileCell);

        const guessFn = row.guess_filename || guessFromFilename(row.file_name || "");
        const guessMla = row.guess_mla || "—";

        const guessFileCell = document.createElement("td");
        guessFileCell.textContent = guessFn || "—";
        tr.appendChild(guessFileCell);

        const guessMlaCell = document.createElement("td");
        guessMlaCell.textContent = guessMla;
        tr.appendChild(guessMlaCell);

        const totalCell = document.createElement("td");
        totalCell.className = "nowrap";
        totalCell.textContent = (row.total_labels != null) ? row.total_labels : "—";
        tr.appendChild(totalCell);

        const inputCell = document.createElement("td");
        const input = document.createElement("input");
        input.type = "text";
        input.className = "name-input";
        input.placeholder = "Student name";
        input.value = (row.guess_mla && row.guess_mla.trim())
          ? row.guess_mla.trim()
          : (guessFn || "");
        inputCell.appendChild(input);
        tr.appendChild(inputCell);

        const btnCell = document.createElement("td");
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "assign-btn";
        btn.textContent = "Assign";
        btn.addEventListener("click", async () => {
          await assignOne(row.id, input.value, btn);
          // After assignment, refresh both sections
          await loadUnassigned(user);
          await loadUsage(user);
        });
        btnCell.appendChild(btn);
        tr.appendChild(btnCell);

        unassignedTableBody.appendChild(tr);
      }
    }

    async function assignOne(id, name, btnEl) {
      const cleaned = (name || "").trim();
      if (!cleaned) {
        alert("Please enter a student name before assigning.");
        return;
      }

      btnEl.disabled = true;
      const oldText = btnEl.textContent;
      btnEl.textContent = "Saving…";

      const { error } = await supa
        .from("mark_events")
        .update({ student_name: cleaned })
        .eq("id", id);

      btnEl.disabled = false;
      btnEl.textContent = oldText;

      if (error) {
        console.error("Assign error:", error);
        alert(
          `Could not assign student name: ${error.message}\n\n` +
          `If this is an RLS/permission issue, you likely need an UPDATE policy like:\n` +
          `create policy "teachers update own rows"\n` +
          `on mark_events for update\n` +
          `using (auth.uid() = user_id)\n` +
          `with check (auth.uid() = user_id);`
        );
      }
    }

    // ===== Load usage (assigned rows only) =====
    async function loadUsage(user) {
      if (!user) return;
      usageStatus.textContent = "Loading…";
      usageTableBody.innerHTML = "";

      const { data, error } = await supa
        .from("mark_events")
        .select("created_at, student_name, assignment_name, mode, total_labels")
        .eq("user_id", user.id)
        .order("created_at", { ascending: false })
        .limit(200);

      if (error) {
        console.error("Error loading usage:", error);
        usageStatus.textContent = `Error loading data: ${error.message}`;
        return;
      }

      const assigned = (data || []).filter(r => r.student_name && r.student_name.trim() !== "");
      if (assigned.length === 0) {
        usageStatus.textContent = "No assigned essays yet.";
        return;
      }

      usageStatus.textContent = `Showing ${assigned.length} assigned essays.`;

      for (const row of assigned) {
        const tr = document.createElement("tr");

        const dateCell = document.createElement("td");
        dateCell.className = "nowrap";
        const d = new Date(row.created_at);
        dateCell.textContent = d.toLocaleDateString();
        tr.appendChild(dateCell);

        const studentCell = document.createElement("td");
        studentCell.textContent = row.student_name || "—";
        tr.appendChild(studentCell);

        const assignmentCell = document.createElement("td");
        assignmentCell.textContent = row.assignment_name || "—";
        tr.appendChild(assignmentCell);

        const modeCell = document.createElement("td");
        modeCell.textContent = row.mode || "—";
        tr.appendChild(modeCell);

        const labelsCell = document.createElement("td");
        labelsCell.className = "nowrap";
        labelsCell.textContent = row.total_labels != null ? row.total_labels : "—";
        tr.appendChild(labelsCell);

        usageTableBody.appendChild(tr);
      }
    }

    // Initial load
    refreshAuthUI();
  </script>
</body>
</html>
